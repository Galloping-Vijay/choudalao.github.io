---
title: "Hyperf 初体验"
date: 2020-07-04T13:15:50+08:00
updated: 2026-02-23T16:43:05+08:00
author: "臭大佬"
categories: [php]
description: "Hyperf 初体验"
cover: "https://www.choudalao.com/uploads/20200704/LOJd8tWeHVmuTaro1CF2ZrWXgCIxsam4WtR1Zz4i.png"
click: 7175
---

# 前言
swoole框架这些年挺火的，这不，搞了个外包是Hyperf框架的，之前只接触过easyswoole,还没撸过Hyperf。感谢外包，让我学习了一波，哈哈哈。

# 安装

### 环境
- ubuntu
- php7.2
- swoole4.X

### composer 安装
```shell
composer create-project hyperf/hyperf-skeleton
```
![](https://www.choudalao.com/uploads/20200704/202007041250419DkHBs.png)
这些是什么，官网也没说，那就都默认吧，但是安装时出现如下错误：
![](https://www.choudalao.com/uploads/20200704/20200704125121K6BxxB.png)
~~proc_open(): fork failed - Cannot allocate memory~~

#### 解决方法：
提示“提示内存不足”，我们可以通过创建swap分区解决这个问题。

##### 查看内存空间
```shell
free -m
```
![](https://www.choudalao.com/uploads/20200704/20200704125743XZE7dN.png)

##### 操作
执行如下三条命名：
```shell
dd if=/dev/zero of=/var/swap.1 bs=1M count=1024
```
```shell
mkswap /var/swap.1
```
```shell
swapon /var/swap.1
```
完成后在运行composer安装框架
![](https://www.choudalao.com/uploads/20200704/202007041259186Doz8i.png)

# 运行

准备就绪，可以开始跑了，在项目根目录下运行如下命令
```shell
sudo php bin/hyperf.php start
```
![](https://www.choudalao.com/uploads/20200705/20200705234630vzE1j9.png)
在运行过程中，如果出现如下错误：

~~failed to listen server port[0.0.0.0:9501], Error: Address already in use[98]~~                                                           
             
![](https://www.choudalao.com/uploads/20200705/20200705233850oxWKt6.png)

框架默认启动9501端口，这是端口被占用的结果。
第一种解决方案就是修改运行端口，修改`config/server.php`文件中的如下截图圈出部分。
![](https://www.choudalao.com/uploads/20200705/20200705234158AS14sK.png)
第二种就是杀死端口，重新启动，步骤如下：
找到PID

```shell
sudo lsof -i:9501
```
![](https://www.choudalao.com/uploads/20200705/20200705234315brAnkP.png)

杀掉进程

```shell
sudo kill -9 30387
```
![](https://www.choudalao.com/uploads/20200705/20200705234436D6FmW8.png)

查看端口
```shell
sudo netstat  -anp  |  grep 9501
```
![](https://www.choudalao.com/uploads/20200705/202007052345407w0oiZ.png)

已经不在了，启动
```shell
sudo php bin/hyperf.php start
```
![](https://www.choudalao.com/uploads/20200705/20200705234623D72ots.png)

### supervisor管理
supervisor在另一篇文章[Supervisor安装及使用](https://www.choudalao.com/article/144 "Supervisor安装及使用")有介绍过，具体操作请移步。

#### 安装
```shell
sudo apt-get install supervisor
```

#### 配置

查看配置所在位置
```shell
sudo whereis supervisor
```
![](https://www.choudalao.com/uploads/20200705/2020070523573978tO3w.png)

进入 `/etc/supervisor` 目录，创建一个配置文件

```shell
sudo vim ./conf.d/hyperf.conf
```
内容如下（xxx部分改成项目根目录）：
```shell
# 新建一个应用并设置一个名称，这里设置为 hyperf

[program:hyperf]

# 设置命令在指定的目录内执行

directory=/xxx

# 这里为您要管理的项目的启动命令

command=php bin/hyperf.php start

# 以哪个用户来运行该进程

user=root

# supervisor 启动时自动该应用

autostart=true

# 进程退出后自动重启进程

autorestart=true

# 进程持续运行多久才认为是启动成功

startsecs=1

# 重试次数

startretries=3

# stderr 日志输出位置,标准错误日志

stderr_logfile=/xxx/runtime/stderr.log

# stdout 日志输出位置,标准输出日志

stdout_logfile=/xxx/runtime/stdout.log

```
#### 启动
```shell
sudo supervisord -c /etc/supervisor/supervisord.conf
```

如果出现如下错误：
![](https://www.choudalao.com/uploads/20200706/20200706001441rxLQS3.png)
这是python版本引起的，编辑/usr/bin/supervisord和/usr/bin/supervisorctl将#!/usr/bin/python修改为#!/usr/bin/python2即可。

![](https://www.choudalao.com/uploads/20200706/20200706001907vYQkGJ.png)

查看是否已启动
```shell
ps -ef|grep supervisord
```
![](https://www.choudalao.com/uploads/20200706/20200706002325tfW9e1.png)

#### 使用 supervisorctl 管理 hyperf
```shell
# 启动 hyperf 应用

supervisorctl start hyperf

# 重启 hyperf 应用

supervisorctl restart hyperf

# 停止 hyperf 应用

supervisorctl stop hyperf 

# 查看所有被管理项目运行状态

supervisorctl status

# 重新加载配置文件

supervisorctl update

# 重新启动所有程序

supervisorctl reload
```

#### 测试
##### 启用
```shell
sudo supervisorctl start hyperf
```
![](https://www.choudalao.com/uploads/20200706/20200706003211NJ065u.png)
![](https://www.choudalao.com/uploads/20200706/20200706003227MkAmvc.png)

##### 关闭
```shell
sudo supervisorctl stop hyperf
```
![](https://www.choudalao.com/uploads/20200706/20200706003311cYSYwy.png)
![](https://www.choudalao.com/uploads/20200706/20200706003336RVZ298.png)