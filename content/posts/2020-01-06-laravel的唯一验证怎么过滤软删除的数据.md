---
title: "laravel的唯一验证怎么过滤软删除的数据"
date: 2020-01-06T15:42:26+08:00
updated: 2026-02-23T15:41:14+08:00
author: "臭大佬"
categories: [php]
description: "laravel的唯一验证怎么过滤软删除的数据"
cover: "https://www.choudalao.com/uploads/20200106/BiyYmXJa1TcW5r49UKxQszPkPXfGHesfNwuJaYga.jpeg"
click: 4366
---

# 问题
如果表用到软删除，在使用表单验证唯一的时候，如果该值存在，则无法过唯一。

栗子：
![](https://www.choudalao.com/uploads/20200106/20200106153417sZKDKb.png)

![](https://www.choudalao.com/uploads/20200106/202001061534533qH2qq.png)

可以看到，domain值为www.2gdddl.com的记录，已经被软删除了，在添加的时候。
![](https://www.choudalao.com/uploads/20200106/202001061535351jO3B2.png)

# 解决方法

#### 方法一
```php
Rule::unique('users')->where(function ($query) {
    $query->where('deleted_at', null)->where('id', '<>', $selfId);
})
```
栗子：

验证规则修改如下

```php
 'domain' => [Rule::unique('hostpool_domainrules')->where(function ($query) {
                        $query->where('deleted_at', null);
})],
```

![](https://www.choudalao.com/uploads/20200106/20200106153843QPLhVU.png)

### 方法二

```php
"unique:users,email_address,$selfId,id,deleted_at,NULL",
```
//表名，对应字段，本条记录id，id，deleted，null
//冒号后面6个空，前两个不用说，中间两个表示忽略id=$selfId，后面两个表示加上限定条件deleted_at=null

栗子 ：
```php
 'domain' => "unique:hostpool_domainrules,deleted_at,NULL",
 ```
 ![](https://www.choudalao.com/uploads/20200106/20200106154110shqxHJ.png)
 
 ![](https://www.choudalao.com/uploads/20200106/20200106154055o04UhP.png)
 
 添加：
 ![](https://www.choudalao.com/uploads/20200106/202001061542111Uobkg.png)
 
 ![](https://www.choudalao.com/uploads/20200106/20200106154222ATehm7.png)