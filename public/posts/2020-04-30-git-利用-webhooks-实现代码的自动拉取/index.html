<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Git 利用 Webhooks 实现代码的自动拉取 - 臭大佬博客</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="Git 利用 Webhooks 实现代码的自动拉取"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=臭大佬博客 rel=home><div class="logo__item logo__text"><div class=logo__title>臭大佬博客</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>首页</span></a></li><li class=menu__item><a class=menu__link href=/post/><span class=menu__text>归档</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>关于</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Git 利用 Webhooks 实现代码的自动拉取</h1></header><div class="content post__content clearfix"><h1 id=webhook-简介>WebHook 简介</h1><p>WebHook 功能是帮助用户 push 代码后，自动回调一个您设定的 http 地址。 这是一个通用的解决方案，用户可以自己根据不同的需求，来编写自己的脚本程序。</p><h1 id=环境>环境</h1><p>服务器：ubuntu
php：7.2.28</p><p>本文以拉取码云（github、Coding等均适用）为例，利用WebHook实现PHP自动部署Git代码。
因为PHP脚本涉及到shell命令执行，所以要删除php.ini里面的禁用函数：exec、shell_exec等。
<img src=https://www.choudalao.com/uploads/20200429/20200429233551WWioHW.png alt></p><p>由于权限问题，所以，需要为目录和文件设置拥有者、所属组。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>sudo</span> <span style=color:#a6e22e>chown</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>R</span> <span style=color:#a6e22e>www</span><span style=color:#f92672>:</span><span style=color:#a6e22e>www</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>www</span><span style=color:#f92672>/</span><span style=color:#a6e22e>wwwroot</span><span style=color:#f92672>/</span><span style=color:#a6e22e>choudalao</span>
</span></span></code></pre></div><h1 id=生成公钥>生成公钥</h1><p>公钥分为</p><ol><li>git用户公钥（SSH公钥），</li><li>部署公钥。</li></ol><h3 id=ssh公钥>SSH公钥</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>// 换成自己的邮箱
</span></span><span style=display:flex><span>ssh-keygen -t rsa -C <span style=color:#e6db74>&#34;1937832819@qq.com&#34;</span>
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20200430/20200430002525zLVDaz.png alt>
查看并复制</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>sudo cat /home/ubuntu/.ssh/id_rsa.pub
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20200430/20200430002612dc4WXl.png alt></p><p>打开码云，点击头像下拉框的设置。新建一个SSH公钥。
<img src=https://www.choudalao.com/uploads/20200430/20200430002657gNlqHW.png alt></p><p><img src=https://www.choudalao.com/uploads/20200430/20200430002725l43pRM.png alt></p><p>如果绑定邮箱，添加成功会受到一条邮件。</p><p><img src=https://www.choudalao.com/uploads/20200430/20200430002925J7G0L5.png alt></p><h3 id=部署公钥>部署公钥</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>// 创建 .ssh目录
</span></span><span style=display:flex><span>sudo mkdir /home/www/.ssh
</span></span><span style=display:flex><span>// 将目录 .ssh 的拥有者、所属组修改为 www（如果已经是就不用改了）
</span></span><span style=display:flex><span>sudo chown -R www:www /home/www/.ssh
</span></span><span style=display:flex><span>// 在 /home/www/.ssh 目录下生成密钥,邮箱请与码云上一致
</span></span><span style=display:flex><span>sudo -Hu www ssh-keygen -t rsa -C <span style=color:#e6db74>&#34;1937832819@qq.com&#34;</span>
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20200430/20200430003148ch0tj2.png alt>
<img src=https://www.choudalao.com/uploads/20200430/20200430003153PGGNdp.png alt>
成功后，查看并复制</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>// 部署公钥生成后，执行下面的代码查看公钥，复制
</span></span><span style=display:flex><span>sudo cat /home/www/.ssh/id_rsa.pub
</span></span></code></pre></div><p>码云上回到我们的项目目录，复制粘贴我们的项目公钥。
<img src=https://www.choudalao.com/uploads/20200430/20200430003238ngAasV.png alt></p><h1 id=git-的全局配置>git 的全局配置</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>sudo -Hu www git config --global credential.helper store <span style=color:#75715e># 永久保存</span>
</span></span><span style=display:flex><span>sudo -Hu www git config --global user.name <span style=color:#e6db74>&#34;1937832819@qq.com&#34;</span> 
</span></span><span style=display:flex><span>sudo -Hu www git config --global user.email <span style=color:#e6db74>&#34;1937832819@qq.com&#34;</span> <span style=color:#75715e># 邮箱请与码云上一致</span>
</span></span></code></pre></div><p>配置完成之后可以 clone 或 pull 项目来验证是否配置成功（注意：要切换成www运行用户来进行操作），若多次操作只需输入一次用户名、密码，即配置成功，若每一次操作都有输入用户名密码，则配置不成功，需要重新检查配置。</p><h1 id=仓库配置>仓库配置</h1><p>打开码云的项目，管理，然后对WebHook进行配置，大概如下
<img src=https://www.choudalao.com/uploads/20200429/20200429234027e9Z77R.png alt></p><h1 id=钩子代码>钩子代码</h1><p>编辑web_hook.php文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * Description:钩子
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * Created by PhpStorm.
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * User: Vijay &lt;1937832819@qq.com&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * Date: 2020/4/29
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * Time: 22:27
</span></span></span><span style=display:flex><span><span style=color:#e6db74> */</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * Description:创建目录
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * User: Vijay &lt;1937832819@qq.com&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * Site: https://www.choudalao.com/
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * Date: 2022/3/17
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * Time: 16:26
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * @param $dir
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * @param int $mode
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * @return bool
</span></span></span><span style=display:flex><span><span style=color:#e6db74> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mkdirs</span>($dir, $mode <span style=color:#f92672>=</span> <span style=color:#ae81ff>0777</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_dir</span>($dir) <span style=color:#f92672>||</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mkdir</span>($dir, $mode)) <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>mkdirs</span>(<span style=color:#a6e22e>dirname</span>($dir), $mode)) <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mkdir</span>($dir, $mode);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 日志目录
</span></span></span><span style=display:flex><span>$path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;./runtime/log&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>mkdirs</span>($path);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 接收码云POST过来的信息
</span></span></span><span style=display:flex><span>$json <span style=color:#f92672>=</span> $GLOBALS[<span style=color:#e6db74>&#39;HTTP_RAW_POST_DATA&#39;</span>];
</span></span><span style=display:flex><span>$data <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_decode</span>($json, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 打开网站目录下的hooks.log文件 需要在服务器上创建 并给写权限
</span></span></span><span style=display:flex><span>$fs <span style=color:#f92672>=</span> <span style=color:#a6e22e>fopen</span>($path <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/webhooks_pull_&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#34;m_d_H&#34;</span>) <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;.log&#39;</span>, <span style=color:#e6db74>&#39;a&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>($fs, <span style=color:#e6db74>&#39;================ Update Start ===============&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// 自定义密码 用于验证 与码云后台设置保持一致
</span></span></span><span style=display:flex><span>$access_token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;zkym&#39;</span>;
</span></span><span style=display:flex><span>$client_token <span style=color:#f92672>=</span> $data[<span style=color:#e6db74>&#39;password&#39;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 请求ip
</span></span></span><span style=display:flex><span>$client_ip <span style=color:#f92672>=</span> $_SERVER[<span style=color:#e6db74>&#39;REMOTE_ADDR&#39;</span>];
</span></span><span style=display:flex><span><span style=color:#75715e>// 把请求的IP和时间写进log
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>($fs, <span style=color:#e6db74>&#39;Request on [&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#34;Y-m-d H:i:s&#34;</span>) <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;] from [&#39;</span> <span style=color:#f92672>.</span> $client_ip <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;]&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>($fs, <span style=color:#e6db74>&#39;php belongs to [&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;whoami&#34;</span>) <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;]&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 验证token 有错就写进日志并退出
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ($client_token <span style=color:#f92672>!==</span> $access_token) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;error 403&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fwrite</span>($fs, <span style=color:#e6db74>&#34;Invalid token [</span><span style=color:#e6db74>{</span>$client_token<span style=color:#e6db74>}</span><span style=color:#e6db74>]&#34;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span>    $fs <span style=color:#66d9ef>and</span> <span style=color:#a6e22e>fclose</span>($fs);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果有需要 可以打开下面，把传送过来的信息写进log 可用于调试，测试成功后注释即可
</span></span></span><span style=display:flex><span><span style=color:#75715e>// fwrite($fs, &#39;Data: &#39; . print_r($data, true) . PHP_EOL);
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 执行shell命令,cd到网站根目录，执行git pull进行拉取代码，并把返回信息写进日志
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>exec</span>(<span style=color:#e6db74>&#39;cd /www/wwwroot/choudalao; git pull 2&lt;&amp;1; chown -R www:www /www/wwwroot/choudalao/*;&#39;</span>, $output);
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>($fs, <span style=color:#e6db74>&#39;Info:&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>print_r</span>($output, <span style=color:#66d9ef>true</span>) <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>($fs, <span style=color:#a6e22e>PHP_EOL</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;================ Update End ===============&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span>$fs <span style=color:#66d9ef>and</span> <span style=color:#a6e22e>fclose</span>($fs);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 调试时打开
</span></span></span><span style=display:flex><span><span style=color:#75715e>// echo json_encode($output);
</span></span></span></code></pre></div><h1 id=调试>调试</h1><p>大部分已经完成了，接下来我们来测试一下，</p><h4 id=本地修改并提交>本地修改并提交</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>git commit -am<span style=color:#e6db74>&#39;s&#39;</span>
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20200430/20200430094231VN4Hmc.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>git push
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20200430/20200430094327ZJnD8d.png alt></p><h3 id=查看我们的日志文件>查看我们的日志文件</h3><p><img src=https://www.choudalao.com/uploads/20200430/20200430094413jvVhF2.png alt></p><h2 id=发现有一个报错>发现有一个报错</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>fatal: could not read Username <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#39;https://gitee.com&#39;</span>: No such device or address
</span></span></code></pre></div><p>这是因为git config文件中没有用户身份信息</p><h3 id=解决方法>解决方法</h3><p>在请求串中加入身份信息即可：
格式</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>https</span><span style=color:#f92672>://</span>[<span style=color:#a6e22e>userName</span>]<span style=color:#f92672>:</span>[<span style=color:#a6e22e>password</span>]<span style=color:#f92672>@</span><span style=color:#a6e22e>gitee</span><span style=color:#f92672>.</span><span style=color:#a6e22e>com</span><span style=color:#f92672>/</span>[<span style=color:#a6e22e>username</span>]<span style=color:#f92672>/</span><span style=color:#a6e22e>project</span><span style=color:#f92672>.</span><span style=color:#a6e22e>git</span>
</span></span></code></pre></div><p>操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>cd .git
</span></span><span style=display:flex><span>vim config
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20200430/20200430095101DhKX0i.png alt></p><h2 id=问题gitfetch_head-permission-denied>问题：.git/FETCH_HEAD: Permission denied</h2><p><img src=https://www.choudalao.com/uploads/20220317/20220317162200ArpO0j.png alt>
.git/FETCH_HEAD的这个文件所属组和所属主是root权限，而我用webhook的用户组是www，解决方法就是修改文件的用户组和所属用户。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>cd</span> <span style=color:#f92672>.</span><span style=color:#a6e22e>git</span><span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>chown</span> <span style=color:#a6e22e>www</span><span style=color:#f92672>:</span><span style=color:#a6e22e>www</span> <span style=color:#a6e22e>FETCH_HEAD</span>
</span></span></code></pre></div><p>本地再次推送，查看日志。
<img src=https://www.choudalao.com/uploads/20200430/202004300952398cdQQJ.png alt></p><p>大功靠成。</p></div></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2026 臭大佬博客.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> 主题</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>