<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Laravel 上传文件存储之后变 zip 格式？ - 臭大佬博客</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="默认情况下，本地 excel 表格通过laravel上传到服务器上变成 zip 格式了。"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/choudalao.github.io/css/style.css><link rel="shortcut icon" href=/choudalao.github.io/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/choudalao.github.io/ title=臭大佬博客 rel=home><div class="logo__item logo__text"><div class=logo__title>臭大佬博客</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/choudalao.github.io/><span class=menu__text>首页</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/posts/><span class=menu__text>归档</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/about/><span class=menu__text>关于</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Laravel 上传文件存储之后变 zip 格式？</h1></header><div class="content post__content clearfix"><h1 id=问题>问题</h1><p>今天在做项目的时候，通过<code>laravel</code>上传 <code>excel</code> 表格文件，到服务端变成了压缩包（zip格式），之前上传图片是不会出现这样的问题的，不知道怎么回事，然后去查了一下中文社区的文档，里面有一句话是这么说的：</p><blockquote><p>Laravel上传文件的扩展名将通过检查文件的 MIME 类型来确定。</p></blockquote><p>那我们来获取一下文件的 MIME 类型，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span>$file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;D:\我的文件\期货\测试.xlsx&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_file</span>($file)) {
</span></span><span style=display:flex><span>$msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;没有找到该文件&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> $msg <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> ;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;文件名：&#39;</span> <span style=color:#f92672>.</span> $file;
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> $msg <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>$mime_type <span style=color:#f92672>=</span> <span style=color:#a6e22e>mime_content_type</span>($file);
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> $mime_type;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// application/octet-stream
</span></span></span></code></pre></div><p>打印出来是<code>application/octet-stream</code>，至于为什么 excel 文档上传之后不是 application/x-xls 或 application/vnd.ms-excel 类型，这就不知道了。这种情况下 laravel 无法判断此文件是什么类型的，得到的是一个<code>zip</code>格式包，我还尝试解压看一下里面是什么东东，发现解压后是一堆别的东西，并不是我们上传的文件。</p><p>为了能得到自己想要的后缀，好对文件数据进行处理，我们得修改一下上传文件的后缀，下面的代码是未做处理前和处理后的代码以及得到的结果对比。</p><h1 id=解决>解决</h1><h3 id=前端代码>前端代码</h3><p>前端上传插件是用到了layui的上传组件，具体使用方法<a href=https://www.layui.com/doc/modules/upload.html title=请查看layui文档>请查看layui文档</a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// html部分
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>button</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;button&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;layui-btn&#34;</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;up_file&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>i</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;layui-icon&#34;</span><span style=color:#f92672>&gt;&amp;</span><span style=color:#75715e>#xe67c;&lt;/i&gt;导入数据&lt;/button&gt;
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// js部分
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 引入上传模块
</span></span></span><span style=display:flex><span><span style=color:#75715e>//upload = layui.upload
</span></span></span><span style=display:flex><span><span style=color:#75715e>// csrf，根据自己的配置赋值哦
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>csrf_token</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span>(<span style=color:#e6db74>&#39;meta[name=&#34;csrf-token&#34;]&#39;</span>)<span style=color:#f92672>.</span><span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;content&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//上传代码
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>uploadInst</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>upload</span><span style=color:#f92672>.</span><span style=color:#a6e22e>render</span>({
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>elem</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;#up_file&#39;</span>
</span></span><span style=display:flex><span>                , <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;接口地址&#39;</span>
</span></span><span style=display:flex><span>                , <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;X-CSRF-TOKEN&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>csrf_token</span>  <span style=color:#75715e>// 根据自身情况配置或者忽略
</span></span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                , <span style=color:#a6e22e>accept</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;file&#39;</span>
</span></span><span style=display:flex><span>                , <span style=color:#a6e22e>field</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;file&#34;</span>
</span></span><span style=display:flex><span>                , <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;file&#39;</span>
</span></span><span style=display:flex><span>                , <span style=color:#a6e22e>exts</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;xls|xlsx&#39;</span> <span style=color:#75715e>//设置一些后缀，用于演示前端验证和后端的验证
</span></span></span><span style=display:flex><span>                , <span style=color:#a6e22e>before</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>obj</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//预读本地文件示例，不支持ie8
</span></span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                , <span style=color:#a6e22e>done</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>res</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//如果上传失败
</span></span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>res</span><span style=color:#f92672>.</span><span style=color:#a6e22e>code</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>layer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span>(<span style=color:#e6db74>&#39;上传失败&#39;</span>, {<span style=color:#a6e22e>icon</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>});
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//上传成功
</span></span></span><span style=display:flex><span>                    <span style=color:#a6e22e>layer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span>(<span style=color:#a6e22e>res</span><span style=color:#f92672>.</span><span style=color:#a6e22e>msg</span>, {<span style=color:#a6e22e>icon</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>});
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//table.reload(&#39;LAY-app-list&#39;); // 重载表格
</span></span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                , <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//演示失败状态，并实现重传
</span></span></span><span style=display:flex><span>                    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>up_logo_text</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span>(<span style=color:#e6db74>&#39;#up_logo_text&#39;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>up_logo_text</span><span style=color:#f92672>.</span><span style=color:#a6e22e>html</span>(<span style=color:#e6db74>&#39;&lt;span style=&#34;color: #FF5722;&#34;&gt;上传失败&lt;/span&gt; &lt;a class=&#34;layui-btn layui-btn-xs demo-reload&#34;&gt;重试&lt;/a&gt;&#39;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>up_logo_text</span><span style=color:#f92672>.</span><span style=color:#a6e22e>find</span>(<span style=color:#e6db74>&#39;.demo-reload&#39;</span>)<span style=color:#f92672>.</span><span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;click&#39;</span>, <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>uploadInst</span><span style=color:#f92672>.</span><span style=color:#a6e22e>upload</span>();
</span></span><span style=display:flex><span>                    });
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span></code></pre></div><h3 id=后端>后端</h3><p><em>self::resJson() 是自己封装的返回方式，请自行替换</em></p><h4 id=修改前的接口>修改前的接口</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Description:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * User: Vijay &lt;1937832819@qq.com&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Date: 2020/09/09
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Time: 11:21
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param Request $request
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @return \Illuminate\Contracts\Routing\ResponseFactory|\Illuminate\Http\Response
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @throws \PhpOffice\PhpSpreadsheet\Exception
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @throws \PhpOffice\PhpSpreadsheet\Reader\Exception
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>import</span>(<span style=color:#a6e22e>Request</span> $request)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$request<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>isMethod</span>(<span style=color:#e6db74>&#39;post&#39;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;请求方式错误&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//上传文件
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$request<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>hasFile</span>(<span style=color:#e6db74>&#39;file&#39;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;请上传文件&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        $date <span style=color:#f92672>=</span> <span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#39;Ymd&#39;</span>);
</span></span><span style=display:flex><span>        $path <span style=color:#f92672>=</span> $request<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>file</span>(<span style=color:#e6db74>&#39;file&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>store</span>(<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#e6db74>&#39;uploads&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$path) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;上传失败&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        $filename <span style=color:#f92672>=</span> <span style=color:#a6e22e>public_path</span>(<span style=color:#e6db74>&#39;/uploads/&#39;</span> <span style=color:#f92672>.</span> $date <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>.</span> $path);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_file</span>($filename)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;未找到该文件&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// XlsxJob::dispatch($filename);// 压入后台队列处理表格数据
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;上传成功，已在后台处理数据&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上传后得到的文件如下：
<img src=https://www.choudalao.com/uploads/20200928/20200928232657w4NshM.png alt></p><h4 id=修改后端接口>修改后端接口</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Description:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * User: Vijay &lt;1937832819@qq.com&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Date: 2020/09/09
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Time: 11:21
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param Request $request
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @return \Illuminate\Contracts\Routing\ResponseFactory|\Illuminate\Http\Response
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @throws \PhpOffice\PhpSpreadsheet\Exception
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @throws \PhpOffice\PhpSpreadsheet\Reader\Exception
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>import</span>(<span style=color:#a6e22e>Request</span> $request)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$request<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>isMethod</span>(<span style=color:#e6db74>&#39;post&#39;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;请求方式错误&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//上传文件
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$request<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>hasFile</span>(<span style=color:#e6db74>&#39;file&#39;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;请上传文件&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置文件后缀白名单
</span></span></span><span style=display:flex><span>        $allowExt <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;csv&#34;</span>, <span style=color:#e6db74>&#34;xls&#34;</span>, <span style=color:#e6db74>&#34;xlsx&#34;</span>];
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置存储目录
</span></span></span><span style=display:flex><span>        $date    <span style=color:#f92672>=</span> <span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#39;Ymd&#39;</span>);
</span></span><span style=display:flex><span>        $tmpPath <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/uploads/&#39;</span> <span style=color:#f92672>.</span> $date;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 绝对路径
</span></span></span><span style=display:flex><span>        $dirPath <span style=color:#f92672>=</span> <span style=color:#a6e22e>public_path</span>($tmpPath);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//如果目标目录不能创建
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_dir</span>($dirPath) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>mkdir</span>($dirPath, <span style=color:#ae81ff>0777</span>, <span style=color:#66d9ef>true</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;上传目录没有创建文件夹权限&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//如果目标目录没有写入权限
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_dir</span>($dirPath) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>is_writable</span>($dirPath)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;上传目录没有写入权限&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取文件
</span></span></span><span style=display:flex><span>        $file <span style=color:#f92672>=</span> $request<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>file</span>(<span style=color:#e6db74>&#39;file&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//校验文件
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isset</span>($file) <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>$file<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>isValid</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;上传失败&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        $ext <span style=color:#f92672>=</span> $file<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getClientOriginalExtension</span>(); <span style=color:#75715e>//上传文件的后缀
</span></span></span><span style=display:flex><span>        <span style=color:#75715e>//判断是否是Excel
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>empty</span>($ext) <span style=color:#66d9ef>or</span> <span style=color:#a6e22e>in_array</span>(<span style=color:#a6e22e>strtolower</span>($ext), $allowExt) <span style=color:#f92672>===</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;不允许的文件类型&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//生成文件名
</span></span></span><span style=display:flex><span>        $fileName <span style=color:#f92672>=</span> <span style=color:#a6e22e>uniqid</span>() <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;_&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>dechex</span>(<span style=color:#a6e22e>microtime</span>(<span style=color:#66d9ef>true</span>)) <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>.</span> $ext;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>//存储文件
</span></span></span><span style=display:flex><span>            $file<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>move</span>($dirPath, $fileName);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取文件路径
</span></span></span><span style=display:flex><span>            $filename <span style=color:#f92672>=</span> $dirPath <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>.</span> $fileName;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_file</span>($filename)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;未找到该文件&#39;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 队列处理表格数据
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>XlsxJob</span><span style=color:#f92672>::</span><span style=color:#a6e22e>dispatch</span>($filename);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;上传成功，已在后台处理数据&#39;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>\Exception</span> $ex) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>::</span><span style=color:#a6e22e>resJson</span>(<span style=color:#ae81ff>1</span>, $ex<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>这样上传就可以得到源文件的后缀了，</p><p><img src=https://www.choudalao.com/uploads/20200928/202009282332405Z9g7m.png alt></p></div></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2026 臭大佬博客.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> 主题</span></div></div></footer></div><script async defer src=/choudalao.github.io/js/menu.js></script></body></html>