<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>php 的 curl 并发请求 - 臭大佬博客</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="php 的 curl 并发请求"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/choudalao.github.io/css/style.css><link rel="shortcut icon" href=/choudalao.github.io/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/choudalao.github.io/ title=臭大佬博客 rel=home><div class="logo__item logo__text"><div class=logo__title>臭大佬博客</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/choudalao.github.io/><span class=menu__text>首页</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/post/><span class=menu__text>归档</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/about/><span class=menu__text>关于</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>php 的 curl 并发请求</h1></header><div class="content post__content clearfix"><p>并发请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span>
</span></span><span style=display:flex><span> 	<span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * 多线程检测
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Date: 2021/12/15
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Time: 23:58
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param array $arr 数组
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param int $timeout
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @return mixed
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>curlMulCheck</span>(<span style=color:#a6e22e>string</span> $url,<span style=color:#66d9ef>array</span> $arr,<span style=color:#a6e22e>int</span> $timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $header <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>        $header[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Accept: image/gif, image/jpeg, image/pjpeg, image/pjpeg, application/x-ms-application, application/x-ms-xbap, application/vnd.ms-xpsdocument, application/xaml+xml, */*&#39;</span>;
</span></span><span style=display:flex><span>        $header[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Connection: Keep-Alive&#39;</span>;
</span></span><span style=display:flex><span>        $header[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Accept-Language: zh-cn&#39;</span>;
</span></span><span style=display:flex><span>        $header[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Cache-Control: no-cache&#39;</span>;
</span></span><span style=display:flex><span>        $mh <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_multi_init</span>(); <span style=color:#75715e>//创建多个curl语柄
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> ($arr <span style=color:#66d9ef>as</span> $k <span style=color:#f92672>=&gt;</span> $v) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 假设每个值是传递的id
</span></span></span><span style=display:flex><span>			$url <span style=color:#f92672>=</span> $url<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;?id=&#39;</span><span style=color:#f92672>.</span>$v;
</span></span><span style=display:flex><span>            $conn[$k] <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_init</span>($url);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>stripos</span>($url, <span style=color:#e6db74>&#34;https://&#34;</span>) <span style=color:#f92672>!==</span> <span style=color:#66d9ef>FALSE</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_SSL_VERIFYPEER</span>, <span style=color:#66d9ef>FALSE</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_SSL_VERIFYHOST</span>, <span style=color:#66d9ef>FALSE</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_SSLVERSION</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_HEADER</span>, <span style=color:#66d9ef>true</span>); <span style=color:#75715e>//如果不为 true, 只会获得响应的正文
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_TIMEOUT</span>, $timeout); <span style=color:#75715e>//设置超时时间
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_HTTPHEADER</span>, $header);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_FOLLOWLOCATION</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_RETURNTRANSFER</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_REFERER</span>, $url);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_setopt</span>($conn[$k], <span style=color:#a6e22e>CURLOPT_USERAGENT</span>, <span style=color:#e6db74>&#39;Mozilla/5.0 (iPhone; CPU iPhone OS 5_1 like Mac OS X) AppleWebKit/534.46 (KHTML, like Gecko) Mobile/9B176 MicroMessenger/4.3.2&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_multi_add_handle</span>($mh, $conn[$k]);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行批处理句柄
</span></span></span><span style=display:flex><span>        $active <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>            $mrc <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_multi_exec</span>($mh, $active); <span style=color:#75715e>//当无数据，active=true
</span></span></span><span style=display:flex><span>        } <span style=color:#66d9ef>while</span> ($mrc <span style=color:#f92672>==</span> <span style=color:#a6e22e>CURLM_CALL_MULTI_PERFORM</span>); <span style=color:#75715e>//当正在接受数据时
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> ($active <span style=color:#f92672>&amp;&amp;</span> $mrc <span style=color:#f92672>==</span> <span style=color:#a6e22e>CURLM_OK</span>) { <span style=color:#75715e>//当无数据时或请求暂停时，active=true
</span></span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>curl_multi_select</span>($mh) <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>                    $mrc <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_multi_exec</span>($mh, $active);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>while</span> ($mrc <span style=color:#f92672>==</span> <span style=color:#a6e22e>CURLM_CALL_MULTI_PERFORM</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> ($arr <span style=color:#66d9ef>as</span> $k <span style=color:#f92672>=&gt;</span> $url) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_error</span>($conn[$k]);
</span></span><span style=display:flex><span>            <span style=color:#75715e>//echo curl_error($conn[$k]);die;
</span></span></span><span style=display:flex><span>            <span style=color:#75715e>//$gg = curl_getinfo($conn[$k], CURLINFO_REDIRECT_URL);
</span></span></span><span style=display:flex><span>            <span style=color:#75715e>//var_dump($conn[$k]);die;
</span></span></span><span style=display:flex><span>            $content <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_multi_getcontent</span>($conn[$k]); <span style=color:#75715e>//获得返回信息
</span></span></span><span style=display:flex><span>            $headerSize <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_getinfo</span>($conn[$k], <span style=color:#a6e22e>CURLINFO_HEADER_SIZE</span>); <span style=color:#75715e>// 获得响应结果里的：头大小
</span></span></span><span style=display:flex><span>            $header <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($content, <span style=color:#ae81ff>0</span>, $headerSize);
</span></span><span style=display:flex><span>           <span style=color:#75715e>// 逻辑代码
</span></span></span><span style=display:flex><span>		   <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_multi_remove_handle</span>($mh, $conn[$k]); <span style=color:#75715e>//释放资源
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>curl_close</span>($conn[$k]); <span style=color:#75715e>//关闭语柄
</span></span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_multi_close</span>($mh);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $resDoamin;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>get、post请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span>	<span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * curl请求
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Date: 2021/12/28
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Time: 17:26
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param string $url 请求地址
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param string $method 请求方式 GET|POST
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param array $param 请求参数
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param string $origin origin
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param string $referer referer
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param null $cookie
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @return bool|string
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>curlExecute</span>(<span style=color:#a6e22e>string</span> $url, <span style=color:#a6e22e>string</span> $method <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;GET&#39;</span>,<span style=color:#66d9ef>array</span> $param <span style=color:#f92672>=</span> [], <span style=color:#a6e22e>string</span> $origin <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#a6e22e>string</span>  $referer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>, $cookie <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $curl <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_init</span>();
</span></span><span style=display:flex><span>        $header <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Accept: application/json, text/javascript, */*; q=0.01&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Accept-Encoding: gzip, deflate, br&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;X-Requested-With: XMLHttpRequest&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Connection: keep-alive&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Sec-Fetch-Dest: empty&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Sec-Fetch-Mode: cors&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Sec-Fetch-Site: same-origin &#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Content-Type: application/x-www-form-urlencoded; charset=UTF-8&#39;</span>,
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($origin) {
</span></span><span style=display:flex><span>            $header[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Origin: &#39;</span> <span style=color:#f92672>.</span> $origin;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($referer) {
</span></span><span style=display:flex><span>            $header[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Referer: &#39;</span> <span style=color:#f92672>.</span> $referer;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($cookie) {
</span></span><span style=display:flex><span>            $header[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Cookie: &#39;</span> <span style=color:#f92672>.</span> $cookie;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        $curloptArr <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_SSL_VERIFYPEER</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_HEADER</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_URL</span> <span style=color:#f92672>=&gt;</span> $url,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_RETURNTRANSFER</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_ENCODING</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_MAXREDIRS</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_TIMEOUT</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_FOLLOWLOCATION</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_HTTP_VERSION</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>CURL_HTTP_VERSION_1_1</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_CUSTOMREQUEST</span> <span style=color:#f92672>=&gt;</span> $method,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>CURLOPT_HTTPHEADER</span> <span style=color:#f92672>=&gt;</span> $header,
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($method <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;POST&#39;</span>) {
</span></span><span style=display:flex><span>            $curloptArr[<span style=color:#a6e22e>CURLOPT_POSTFIELDS</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>http_build_query</span>($param);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_setopt_array</span>($curl, $curloptArr);
</span></span><span style=display:flex><span>        $response <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_exec</span>($curl);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_close</span>($curl);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $response;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>使用方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span>$response <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>curlExecute</span>($url, <span style=color:#e6db74>&#39;POST&#39;</span>, $param, $url, $url, $cookie);
</span></span><span style=display:flex><span><span style=color:#75715e>// 分离header和body
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>list</span>($header, $body) <span style=color:#f92672>=</span> <span style=color:#a6e22e>explode</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>&#34;</span>, $response, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// 提取cookie
</span></span></span><span style=display:flex><span>$preg_cookie <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/Set-Cookie: (.*?);/m&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>preg_match_all</span>($preg_cookie, $header, $cookie);
</span></span><span style=display:flex><span><span style=color:#75715e>// 得到cookie 字符串
</span></span></span><span style=display:flex><span>$cookieStr <span style=color:#f92672>=</span> <span style=color:#a6e22e>implode</span>(<span style=color:#e6db74>&#39;;&#39;</span>, $cookie[<span style=color:#ae81ff>1</span>]);
</span></span></code></pre></div></div></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2026 臭大佬博客.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> 主题</span></div></div></footer></div><script async defer src=/choudalao.github.io/js/menu.js></script></body></html>