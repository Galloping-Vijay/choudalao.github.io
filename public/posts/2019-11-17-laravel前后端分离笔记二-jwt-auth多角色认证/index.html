<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>laravel前后端分离笔记二 -- jwt-auth多角色认证 - 臭大佬博客</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="jwt-auth多角色认证"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=臭大佬博客 rel=home><div class="logo__item logo__text"><div class=logo__title>臭大佬博客</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>首页</span></a></li><li class=menu__item><a class=menu__link href=/post/><span class=menu__text>归档</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>关于</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>laravel前后端分离笔记二 -- jwt-auth多角色认证</h1></header><div class="content post__content clearfix"><p>前台用户功能我们已经基本完成，下面按照前台，搭建后台管理admin相应的功能。</p><h1 id=数据迁移>数据迁移</h1><p>里面的字段我们按照users的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>php artisan make:migration create_admins_table
</span></span></code></pre></div><p>填充字段</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span>  <span style=color:#f92672>*/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>up</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Schema</span><span style=color:#f92672>::</span><span style=color:#a6e22e>create</span>(<span style=color:#e6db74>&#39;admins&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>Blueprint</span> $table) {
</span></span><span style=display:flex><span>            $table<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>bigIncrements</span>(<span style=color:#e6db74>&#39;id&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>comment</span>(<span style=color:#e6db74>&#39;用户表&#39;</span>);
</span></span><span style=display:flex><span>            $table<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>string</span>(<span style=color:#e6db74>&#39;name&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>comment</span>(<span style=color:#e6db74>&#39;用户昵称&#39;</span>);
</span></span><span style=display:flex><span>            $table<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>text</span>(<span style=color:#e6db74>&#39;last_token&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>comment</span>(<span style=color:#e6db74>&#39;登陆时的token&#39;</span>);
</span></span><span style=display:flex><span>            $table<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>tinyInteger</span>(<span style=color:#e6db74>&#39;status&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>default</span>(<span style=color:#e6db74>&#39;0&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>comment</span>(<span style=color:#e6db74>&#39;用户状态 -1代表已删除 0代表正常 1代表冻结&#39;</span>);
</span></span><span style=display:flex><span>            $table<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>string</span>(<span style=color:#e6db74>&#39;email&#39;</span>,<span style=color:#ae81ff>150</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>unique</span>();
</span></span><span style=display:flex><span>            $table<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>timestamp</span>(<span style=color:#e6db74>&#39;email_verified_at&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>nullable</span>();
</span></span><span style=display:flex><span>            $table<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>string</span>(<span style=color:#e6db74>&#39;password&#39;</span>);
</span></span><span style=display:flex><span>            $table<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>rememberToken</span>();
</span></span><span style=display:flex><span>            $table<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>timestamps</span>();
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20191117/20191117213200DRiK23.png alt></p><p>运行迁移</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>php</span> <span style=color:#a6e22e>artisan</span> <span style=color:#a6e22e>migrate</span>
</span></span></code></pre></div><h1 id=数据填充>数据填充</h1><p>填充一些数据到admins表</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>php</span> <span style=color:#a6e22e>artisan</span> <span style=color:#a6e22e>make</span><span style=color:#f92672>:</span><span style=color:#a6e22e>seeder</span> <span style=color:#a6e22e>AdminsTableSeeder</span>
</span></span></code></pre></div><p>插入数据
<img src=https://www.choudalao.com/uploads/20191117/20191117213412ibfgMe.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>php</span> <span style=color:#a6e22e>artisan</span> <span style=color:#a6e22e>db</span><span style=color:#f92672>:</span><span style=color:#a6e22e>seed</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#a6e22e>AdminsTableSeeder</span>
</span></span></code></pre></div><h1 id=admin相关文件>Admin相关文件</h1><p>根据users相关配套，我们把相应的文件也复制一份，相应的命名和模型需要修改，后期用到再说明。</p><h1 id=admin认证>admin认证</h1><p><code>config/auth.php</code>修改配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#e6db74>&#39;guards&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;web&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;driver&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;session&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;provider&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;users&#39;</span>,
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;api&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;driver&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;jwt&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;provider&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;users&#39;</span>,
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;admin&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;driver&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;jwt&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;provider&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;admins&#39;</span>,
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span><span style=color:#75715e>//....
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;providers&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;users&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;driver&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;eloquent&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;model&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>App\Models\User</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;admins&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;driver&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;eloquent&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;model&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>App\Models\Admin</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// &#39;users&#39; =&gt; [
</span></span></span><span style=display:flex><span>        <span style=color:#75715e>//     &#39;driver&#39; =&gt; &#39;database&#39;,
</span></span></span><span style=display:flex><span>        <span style=color:#75715e>//     &#39;table&#39; =&gt; &#39;users&#39;,
</span></span></span><span style=display:flex><span>        <span style=color:#75715e>// ],
</span></span></span><span style=display:flex><span>    ],
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20191117/20191117214155W6Gegl.png alt>
<img src=https://www.choudalao.com/uploads/20191117/20191117214206LmtQgy.png alt>
当 Auth::guard(&lsquo;admin&rsquo;) 时，就会自动查找 Admin 模型文件。</p><h1 id=刷新用户认证中间件>刷新用户认证中间件</h1><p>刷新token,文件地址 <code>app/Http/Middleware/Api/RefreshAdminTokenMiddleware.php</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>App\Http\Middleware\Api</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Illuminate\Support\Facades\Auth</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Closure</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Tymon\JWTAuth\Exceptions\JWTException</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Tymon\JWTAuth\Http\Middleware\BaseMiddleware</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Tymon\JWTAuth\Exceptions\TokenInvalidException</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Tymon\JWTAuth\Exceptions\TokenExpiredException</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RefreshAdminTokenMiddleware</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseMiddleware</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Handle an incoming request.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     *
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param  \Illuminate\Http\Request $request
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param  \Closure $next
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     *
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @throws \Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     *
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @return mixed
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handle</span>($request, <span style=color:#a6e22e>Closure</span> $next)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查此次请求中是否带有 token，如果没有则抛出异常。
</span></span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>checkForToken</span>($request);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//1. 格式通过，验证是否是专属于这个的token
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取当前守护的名称
</span></span></span><span style=display:flex><span>        $present_guard <span style=color:#f92672>=</span> <span style=color:#a6e22e>Auth</span><span style=color:#f92672>::</span><span style=color:#a6e22e>getDefaultDriver</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取当前token
</span></span></span><span style=display:flex><span>        $token<span style=color:#f92672>=</span><span style=color:#a6e22e>Auth</span><span style=color:#f92672>::</span><span style=color:#a6e22e>getToken</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//即使过期了，也能获取到token里的 载荷 信息。
</span></span></span><span style=display:flex><span>        $payload <span style=color:#f92672>=</span> <span style=color:#a6e22e>Auth</span><span style=color:#f92672>::</span><span style=color:#a6e22e>manager</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getJWTProvider</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>decode</span>($token<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//如果不包含guard字段或者guard所对应的值与当前的guard守护值不相同
</span></span></span><span style=display:flex><span>        <span style=color:#75715e>//证明是不属于当前guard守护的token
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#66d9ef>empty</span>($payload[<span style=color:#e6db74>&#39;guard&#39;</span>])<span style=color:#f92672>||</span>$payload[<span style=color:#e6db74>&#39;guard&#39;</span>]<span style=color:#f92672>!=</span>$present_guard){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TokenInvalidException</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//使用 try 包裹，以捕捉 token 过期所抛出的 TokenExpiredException  异常
</span></span></span><span style=display:flex><span>        <span style=color:#75715e>//2. 此时进入的都是属于当前guard守护的token
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 检测用户的登录状态，如果正常则通过
</span></span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>auth</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>parseToken</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>authenticate</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> $next($request);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UnauthorizedHttpException</span>(<span style=color:#e6db74>&#39;jwt-auth&#39;</span>, <span style=color:#e6db74>&#39;未登录&#39;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>TokenExpiredException</span> $exception) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 3. 此处捕获到了 token 过期所抛出的 TokenExpiredException 异常，我们在这里需要做的是刷新该用户的 token 并将它添加到响应头中
</span></span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 刷新用户的 token
</span></span></span><span style=display:flex><span>                $token <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>auth</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>refresh</span>();
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 使用一次性登录以保证此次请求的成功
</span></span></span><span style=display:flex><span>                <span style=color:#a6e22e>Auth</span><span style=color:#f92672>::</span><span style=color:#a6e22e>onceUsingId</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>auth</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>manager</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getPayloadFactory</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>buildClaimsCollection</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>toPlainArray</span>()[<span style=color:#e6db74>&#39;sub&#39;</span>]);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>JWTException</span> $exception) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 如果捕获到此异常，即代表 refresh 也过期了，用户无法刷新令牌，需要重新登录。
</span></span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UnauthorizedHttpException</span>(<span style=color:#e6db74>&#39;jwt-auth&#39;</span>, $exception<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 在响应头中返回新的 token
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setAuthenticationHeader</span>($next($request), $token);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20191117/20191117214606POeCWe.png alt></p><h1 id=路由>路由</h1><p>routes/api.php</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Illuminate\Http\Request</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Illuminate\Support\Facades\Route</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>|--------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>| API Routes
</span></span></span><span style=display:flex><span><span style=color:#75715e>|--------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>|
</span></span></span><span style=display:flex><span><span style=color:#75715e>| Here is where you can register API routes for your application. These
</span></span></span><span style=display:flex><span><span style=color:#75715e>| routes are loaded by the RouteServiceProvider within a group which
</span></span></span><span style=display:flex><span><span style=color:#75715e>| is assigned the &#34;api&#34; middleware group. Enjoy building your API!
</span></span></span><span style=display:flex><span><span style=color:#75715e>|
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>middleware</span>(<span style=color:#e6db74>&#39;auth:api&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/user&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>Request</span> $request) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $request<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>user</span>();
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>namespace</span>(<span style=color:#e6db74>&#39;Api&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>prefix</span>(<span style=color:#e6db74>&#39;v1&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>middleware</span>(<span style=color:#e6db74>&#39;cors&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>group</span>(<span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//用户注册
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/users&#39;</span>,<span style=color:#e6db74>&#39;UserController@store&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;users.store&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//用户登录
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/login&#39;</span>,<span style=color:#e6db74>&#39;UserController@login&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;users.login&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>middleware</span>(<span style=color:#e6db74>&#39;api.refresh&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>group</span>(<span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//当前用户信息
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/users/info&#39;</span>,<span style=color:#e6db74>&#39;UserController@info&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;users.info&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//用户列表
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/users&#39;</span>,<span style=color:#e6db74>&#39;UserController@index&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;users.index&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//用户信息
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/users/{user}&#39;</span>,<span style=color:#e6db74>&#39;UserController@show&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;users.show&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//用户退出
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/logout&#39;</span>,<span style=color:#e6db74>&#39;UserController@logout&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;users.logout&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>middleware</span>(<span style=color:#e6db74>&#39;admin.guard&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>group</span>(<span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//管理员注册
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/admins&#39;</span>, <span style=color:#e6db74>&#39;AdminController@store&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;admins.store&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//管理员登录
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/admin/login&#39;</span>, <span style=color:#e6db74>&#39;AdminController@login&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;admins.login&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>middleware</span>(<span style=color:#e6db74>&#39;admin.refresh&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>group</span>(<span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>            <span style=color:#75715e>//当前管理员信息
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/admins/info&#39;</span>, <span style=color:#e6db74>&#39;AdminController@info&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;admins.info&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>//管理员列表
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/admins&#39;</span>, <span style=color:#e6db74>&#39;AdminController@index&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;admins.index&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>//管理员信息
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/admins/{user}&#39;</span>, <span style=color:#e6db74>&#39;AdminController@show&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;admins.show&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>//管理员退出
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>Route</span><span style=color:#f92672>::</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/admins/logout&#39;</span>, <span style=color:#e6db74>&#39;AdminController@logout&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>(<span style=color:#e6db74>&#39;admins.logout&#39;</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p><img src=https://www.choudalao.com/uploads/20191117/20191117214639ic6UWD.png alt></p><h1 id=控制器>控制器</h1><p><code>App\Http\Controllers\Api\AdminController.php</code>内容如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>App\Http\Controllers\Api</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>App\Http\Requests\Api\AdminRequest</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>App\Http\Resources\Api\AdminResource</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>App\Models\Admin</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Illuminate\Http\Request</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Illuminate\Support\Facades\Auth</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AdminController</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseController</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>index</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $admins <span style=color:#f92672>=</span> <span style=color:#a6e22e>Admin</span><span style=color:#f92672>::</span><span style=color:#a6e22e>paginate</span>(<span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>AdminResource</span><span style=color:#f92672>::</span><span style=color:#a6e22e>collection</span>($admins);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>show</span>(<span style=color:#a6e22e>Admin</span> $admin)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>success</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AdminResource</span>($admin));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>info</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $admins <span style=color:#f92672>=</span> <span style=color:#a6e22e>Auth</span><span style=color:#f92672>::</span><span style=color:#a6e22e>user</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>success</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AdminResource</span>($admins));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>login</span>(<span style=color:#a6e22e>Request</span> $request)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取当前守护的名称
</span></span></span><span style=display:flex><span>        $present_guard <span style=color:#f92672>=</span><span style=color:#a6e22e>Auth</span><span style=color:#f92672>::</span><span style=color:#a6e22e>getDefaultDriver</span>();
</span></span><span style=display:flex><span>        $token <span style=color:#f92672>=</span> <span style=color:#a6e22e>Auth</span><span style=color:#f92672>::</span><span style=color:#a6e22e>claims</span>([<span style=color:#e6db74>&#39;guard&#39;</span><span style=color:#f92672>=&gt;</span>$present_guard])<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>attempt</span>([<span style=color:#e6db74>&#39;name&#39;</span> <span style=color:#f92672>=&gt;</span> $request<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span>, <span style=color:#e6db74>&#39;password&#39;</span> <span style=color:#f92672>=&gt;</span> $request<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>password</span>]);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($token) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setStatusCode</span>(<span style=color:#ae81ff>201</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>success</span>([<span style=color:#e6db74>&#39;token&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;bearer &#39;</span> <span style=color:#f92672>.</span> $token]);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>failed</span>(<span style=color:#e6db74>&#39;账号或密码错误&#39;</span>, <span style=color:#ae81ff>400</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>logout</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Auth</span><span style=color:#f92672>::</span><span style=color:#a6e22e>logout</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>success</span>(<span style=color:#e6db74>&#39;退出成功...&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=测试>测试</h1><p><img src=https://www.choudalao.com/uploads/20191117/20191117214930YeKqvI.png alt>
<img src=https://www.choudalao.com/uploads/20191117/20191117214941DbXhX9.png alt></p><h1 id=自动区分-guard>自动区分 guard</h1><p>我希望可以让 guard 自动化，如果我请求的是 users 的，我就守护 api。如果我请求的是 admins 的，我就守护 admin。</p><p>接下来，就以 admins 的为例，users 的保持不动，创建中间件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>php</span> <span style=color:#a6e22e>artisan</span> <span style=color:#a6e22e>make</span><span style=color:#f92672>:</span><span style=color:#a6e22e>middleware</span> <span style=color:#a6e22e>Api</span><span style=color:#f92672>/</span><span style=color:#a6e22e>AdminGuardMiddleware</span>
</span></span></code></pre></div><p>代码内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> <span style=color:#a6e22e>App\Http\Middleware\Api</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>Closure</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AdminGuardMiddleware</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * Handle an incoming request.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     *
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param  \Illuminate\Http\Request $request
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @param  \Closure $next
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     *
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @throws \Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     *
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * @return mixed
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handle</span>($request, <span style=color:#a6e22e>Closure</span> $next)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>config</span>([<span style=color:#e6db74>&#39;auth.defaults.guard&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;admin&#39;</span>]);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $next($request);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>打开 app/Http 目录下的 Kernel.php 文件，添加如下一行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>protected</span> $routeMiddleware <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#f92672>......</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;admin.guard&#39;</span><span style=color:#f92672>=&gt;</span><span style=color:#a6e22e>\App\Http\Middleware\Api\AdminGuardMiddleware</span><span style=color:#f92672>::</span><span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>];
</span></span></code></pre></div><h1 id=测试-1>测试</h1><p>再次进行登录测试，可以区分user和admin。</p></div></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2026 臭大佬博客.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> 主题</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>