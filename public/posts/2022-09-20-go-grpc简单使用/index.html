<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>go grpc简单使用 - 臭大佬博客</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="go grpc简单使用"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/choudalao.github.io/css/style.css><link rel="shortcut icon" href=/choudalao.github.io/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/choudalao.github.io/ title=臭大佬博客 rel=home><div class="logo__item logo__text"><div class=logo__title>臭大佬博客</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/choudalao.github.io/><span class=menu__text>首页</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/categories/><span class=menu__text>分类</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/tags/><span class=menu__text>标签</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/posts/><span class=menu__text>归档</span></a></li><li class=menu__item><a class=menu__link href=/choudalao.github.io/about/><span class=menu__text>关于</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>go grpc简单使用</h1></header><div class="content post__content clearfix"><h1 id=简介>简介</h1><p>微服务架构中，由于每个服务对应的代码库是独立运行的，无法直接调用，彼此间的通信就是个大问题.</p><p><code>gRPC</code>可以实现将大的项目拆分为多个小且独立的业务模块，也就是服务。各服务间使用高效的<code>protobuf</code>协议进行<code>RPC</code>调用，<code>gRPC</code>默认使用<code>protocol buffers</code>，这是<code>google</code>开源的一套成熟的结构数据序列化机制。</p><h1 id=安装>安装</h1><h3 id=下载grpc通用编译器>下载grpc通用编译器</h3><p>在如下地址获取编译器</p><blockquote><p><a href=https://github.com/protocolbuffers/protobuf/releases>https://github.com/protocolbuffers/protobuf/releases</a></p></blockquote><p>解压出来因平台而异会是一个<code>protoc</code>或者<code>protoc.exe</code></p><h3 id=把下载的二进制文件路径添加到环境变量中为了能全局访问protoc>把下载的二进制文件路径添加到环境变量中(为了能全局访问protoc)</h3><h5 id=win下>win下</h5><p>win下载<code>protoc-xx.x-win64.zip</code>，把解压出来了的<code>protoc.exe</code>文件放到<code>GOPATH</code>下的<code>bin</code>目录中。</p><h5 id=linux下>linux下</h5><p>以centos 为例，把解压的<code>protoc</code>文件，添加到环境变量的文件中，步骤大致如下：下载<code>protoc-xxx.x-linux-x86_64.zip</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 解压</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>unzip</span> <span style=color:#a6e22e>protoc</span><span style=color:#f92672>-</span><span style=color:#ae81ff>21.6</span><span style=color:#f92672>-</span><span style=color:#a6e22e>linux</span><span style=color:#f92672>-</span><span style=color:#a6e22e>x86_64</span>.<span style=color:#a6e22e>zip</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 移动到go目录下</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>whereis</span> <span style=color:#66d9ef>go</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// go: /usr/local/go /usr/local/go/bin/go</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mv</span> .<span style=color:#f92672>/</span><span style=color:#a6e22e>bin</span><span style=color:#f92672>/</span><span style=color:#a6e22e>protoc</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>local</span><span style=color:#f92672>/</span><span style=color:#66d9ef>go</span><span style=color:#f92672>/</span><span style=color:#a6e22e>bin</span><span style=color:#f92672>/</span>
</span></span></code></pre></div><p>查看版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>protoc</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>version</span>
</span></span></code></pre></div><h3 id=安装协议编译器插件>安装协议编译器插件</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>go</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>google</span>.<span style=color:#a6e22e>golang</span>.<span style=color:#a6e22e>org</span><span style=color:#f92672>/</span><span style=color:#a6e22e>protobuf</span><span style=color:#f92672>/</span><span style=color:#a6e22e>cmd</span><span style=color:#f92672>/</span><span style=color:#a6e22e>protoc</span><span style=color:#f92672>-</span><span style=color:#a6e22e>gen</span><span style=color:#f92672>-</span><span style=color:#66d9ef>go</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>go</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>google</span>.<span style=color:#a6e22e>golang</span>.<span style=color:#a6e22e>org</span><span style=color:#f92672>/</span><span style=color:#a6e22e>grpc</span><span style=color:#f92672>/</span><span style=color:#a6e22e>cmd</span><span style=color:#f92672>/</span><span style=color:#a6e22e>protoc</span><span style=color:#f92672>-</span><span style=color:#a6e22e>gen</span><span style=color:#f92672>-</span><span style=color:#66d9ef>go</span><span style=color:#f92672>-</span><span style=color:#a6e22e>grpc</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>latest</span>
</span></span></code></pre></div><p><code>linux</code>还需要执行如下命令，更新<code>PATH</code>，以便协议编译器可以找到插件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>export</span> <span style=color:#a6e22e>PATH</span>=<span style=color:#e6db74>&#34;$PATH:$(go env GOPATH)/bin&#34;</span>
</span></span></code></pre></div><h1 id=使用>使用</h1><h3 id=初始化>初始化</h3><p>新建一个<code>grpc</code>目录，</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>go</span> <span style=color:#a6e22e>mod</span> <span style=color:#a6e22e>init</span> <span style=color:#a6e22e>grpc</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//go mod tidy</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>go</span> <span style=color:#a6e22e>get</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>u</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>v</span> <span style=color:#a6e22e>google</span>.<span style=color:#a6e22e>golang</span>.<span style=color:#a6e22e>org</span><span style=color:#f92672>/</span><span style=color:#a6e22e>grpc</span>
</span></span></code></pre></div><h3 id=编写proto文件>编写proto文件</h3><p>在当前目录下建一个<code>helloworld</code>目录，然后在里面创建<code>helloworld.proto</code>文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 指定的当前proto语法的版本</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>syntax</span> = <span style=color:#e6db74>&#34;proto3&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>hello</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// 生成 go 类的包名 hello</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>option</span> <span style=color:#a6e22e>go_package</span> = <span style=color:#e6db74>&#34;./;hello&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// // 生成 java 类的包名</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// option java_package = &#34;&#34;;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 定义request</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>message</span> <span style=color:#a6e22e>HelloRequest</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>name</span> = <span style=color:#ae81ff>1</span>;<span style=color:#75715e>// 1代表顺序</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// 定义response</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>message</span> <span style=color:#a6e22e>HelloReply</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>message</span> = <span style=color:#ae81ff>1</span>;<span style=color:#75715e>// 1代表顺序</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// 定义服务主体</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>service</span> <span style=color:#a6e22e>Greeter</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 定义方法</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rpc</span> <span style=color:#a6e22e>SayHello</span> (<span style=color:#a6e22e>HelloRequest</span>) <span style=color:#a6e22e>returns</span> (<span style=color:#a6e22e>HelloReply</span>) {}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在<code>grpc</code>目录执行如下命令：</p><h5 id=win>win</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>protoc</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>go_out</span>=.<span style=color:#f92672>/</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>go_opt</span>=<span style=color:#a6e22e>paths</span>=<span style=color:#a6e22e>source_relative</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>--</span><span style=color:#66d9ef>go</span><span style=color:#f92672>-</span><span style=color:#a6e22e>grpc_out</span>=.<span style=color:#f92672>/</span> <span style=color:#f92672>--</span><span style=color:#66d9ef>go</span><span style=color:#f92672>-</span><span style=color:#a6e22e>grpc_opt</span>=<span style=color:#a6e22e>paths</span>=<span style=color:#a6e22e>source_relative</span>  .<span style=color:#f92672>/</span><span style=color:#a6e22e>helloworld</span><span style=color:#f92672>/</span><span style=color:#a6e22e>helloworld</span>.<span style=color:#a6e22e>proto</span>
</span></span></code></pre></div><h5 id=linux>linux</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>protoc</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>go_out</span>=. <span style=color:#f92672>--</span><span style=color:#a6e22e>go_opt</span>=<span style=color:#a6e22e>paths</span>=<span style=color:#a6e22e>source_relative</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>--</span><span style=color:#66d9ef>go</span><span style=color:#f92672>-</span><span style=color:#a6e22e>grpc_out</span>=. <span style=color:#f92672>--</span><span style=color:#66d9ef>go</span><span style=color:#f92672>-</span><span style=color:#a6e22e>grpc_opt</span>=<span style=color:#a6e22e>paths</span>=<span style=color:#a6e22e>source_relative</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>helloworld</span><span style=color:#f92672>/</span><span style=color:#a6e22e>helloworld</span>.<span style=color:#a6e22e>proto</span>
</span></span></code></pre></div><p>目录<code>helloworld</code>下生成了<code>helloworld.pb.go</code>文件和<code>hello.pb.go</code>文件。</p><h4 id=protoc-介绍>protoc 介绍</h4><ul><li><p>在gRPC跟目录下使用如下命令进行编译</p></li><li><p>protoc &ndash;go_out=. &ndash;go-grpc_out=. ./helloworld.proto，生成对应的.pb.go和_grpc.pb.go两个文件，前者主要是对message生成对应的结构体和方法，后者生成gRPC，主要是对service生成对应的interface和方法</p></li><li><p>go_out=. 指定生成的pb.go文件所在目录(如果没有该目录，需要手动提前创建)，.代表当前protoc执行目录，结合.proto文件中的option go_package，其最终的生成文件目录为go_out指定目录/go_package指定目录</p></li><li><p>go-grpc_out针对_grpc.pb.go文件，作用同上</p></li><li><p>另外官网文档里还有一个&ndash;go_opt=paths=source_relative，其含义代表生成的.pb.go文件路径不依赖于.proto文件中的option go_package配置项，直接在go_out指定的目录下生成.pb.go文件（.pb.go文件的package名还是由option go_package决定）</p></li><li><p>&ndash;go-grpc_opt=paths=source_relative，针对_grpc.pb.go文件，作用同上。</p></li></ul><p>所以，根据.proto文件中的option go_package配置项生成文件如下（需要自己根据go_package先创建目录）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>protoc</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>go_out</span>=. <span style=color:#f92672>--</span><span style=color:#a6e22e>go_opt</span>=<span style=color:#a6e22e>paths</span>=<span style=color:#f92672>import</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>--</span><span style=color:#66d9ef>go</span><span style=color:#f92672>-</span><span style=color:#a6e22e>grpc_out</span>=. <span style=color:#f92672>--</span><span style=color:#66d9ef>go</span><span style=color:#f92672>-</span><span style=color:#a6e22e>grpc_opt</span>=<span style=color:#a6e22e>paths</span>=<span style=color:#f92672>import</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>helloworld</span><span style=color:#f92672>/</span><span style=color:#a6e22e>helloworld</span>.<span style=color:#a6e22e>proto</span>
</span></span></code></pre></div><h3 id=编写rpc的server和client>编写RPC的server和client</h3><p>在根目录下，创建如下两个文件
<code>server</code>服务端代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// server.go</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pb</span> <span style=color:#e6db74>&#34;grpc/helloworld&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// go run server.go -port=500 可以传值</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>port</span> = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Int</span>(<span style=color:#e6db74>&#34;port&#34;</span>, <span style=color:#ae81ff>50051</span>, <span style=color:#e6db74>&#34;The server port&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 服务器用于实现 helloworld.GreeterServer。</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>server</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>UnimplementedGreeterServer</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// SayHello 实现 helloworld.GreeterServer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>server</span>) <span style=color:#a6e22e>SayHello</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>in</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>HelloRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>HelloReply</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Received: %v&#34;</span>, <span style=color:#a6e22e>in</span>.<span style=color:#a6e22e>GetName</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>HelloReply</span>{<span style=color:#a6e22e>Message</span>: <span style=color:#e6db74>&#34;Hello &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>in</span>.<span style=color:#a6e22e>GetName</span>()}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 把用户传递的命令行参数解析为对应变量的值</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lis</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Listen</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;:%d&#34;</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>port</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;failed to listen: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>NewServer</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>RegisterGreeterServer</span>(<span style=color:#a6e22e>s</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>server</span>{})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;server listening at %v&#34;</span>, <span style=color:#a6e22e>lis</span>.<span style=color:#a6e22e>Addr</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Serve</span>(<span style=color:#a6e22e>lis</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;failed to serve: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>client</code>客户端代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// client.go</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;google.golang.org/grpc/credentials/insecure&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pb</span> <span style=color:#e6db74>&#34;grpc/helloworld&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>defaultName</span> = <span style=color:#e6db74>&#34;world&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>addr</span> = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#e6db74>&#34;localhost:50051&#34;</span>, <span style=color:#e6db74>&#34;the address to connect to&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>name</span> = <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#a6e22e>defaultName</span>, <span style=color:#e6db74>&#34;Name to greet&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 连接rpc服务</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithTransportCredentials</span>(<span style=color:#a6e22e>insecure</span>.<span style=color:#a6e22e>NewCredentials</span>()))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;did not connect: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>NewGreeterClient</span>(<span style=color:#a6e22e>conn</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>SayHello</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>HelloRequest</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#f92672>*</span><span style=color:#a6e22e>name</span>})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;could not greet: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Greeting: %s&#34;</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetMessage</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>先将服务端启动，然后运行客户端.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>go</span> <span style=color:#a6e22e>run</span> <span style=color:#a6e22e>server</span>.<span style=color:#66d9ef>go</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//2022/09/20 22:42:51 server listening at //[::]:50051</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//2022/09/20 22:44:12 Received: world</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>go</span> <span style=color:#a6e22e>run</span> <span style=color:#a6e22e>client</span>.<span style=color:#66d9ef>go</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//2022/09/20 22:44:12 Greeting: Hello world</span>
</span></span></code></pre></div><h3 id=nginx-转发>Nginx 转发</h3><p>与HTTP请求一样，gRPC请求也可以通过Nginx进行负载均衡和路由转发。</p><p>在使用Nginx转发gRPC请求时，需要使用Nginx的gRPC插件。Nginx的gRPC插件可以通过源码编译的方式进行安装，也可以使用第三方的二进制包安装。安装完成后，需要在Nginx配置文件中添加gRPC服务的转发规则。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>upstream</span> <span style=color:#a6e22e>grpc_servers</span> {
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>配置gRPC服务的后端服务器地址和端口</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>127.0.0.1</span>:<span style=color:#ae81ff>50051</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server</span> <span style=color:#ae81ff>127.0.0.1</span>:<span style=color:#ae81ff>50052</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>server_name</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>location</span> <span style=color:#f92672>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>使用gRPC插件进行转发</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>grpc_pass</span> <span style=color:#a6e22e>grpc</span>:<span style=color:#75715e>//grpc_servers;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们定义了一个名为grpc_servers的upstream块，其中配置了两个gRPC服务的后端服务器地址和端口。然后，在server块中定义了一个名为grpc.example.com的虚拟主机，并配置了一个location块，使用gRPC插件进行转发。</p><p>需要注意的是，在使用Nginx转发gRPC请求时，需要使用gRPC插件进行转发，而不是HTTP插件。此外，还需要确保gRPC服务端和Nginx服务器之间的通信是安全的，可以使用TLS协议进行加密。</p></div></article></main></div><aside class=sidebar><div class="widget-categories widget"><h4 class=widget__title>分类</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/ai/>AI</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/go/>Go</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/linux/>Linux</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/mysql/>MYSQL</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/php/>Php</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/python/>Python</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/%E4%B8%AA%E4%BA%BA/>个人</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/%E5%85%B6%E4%BB%96/>其他</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/categories/%E5%89%8D%E7%AB%AF/>前端</a></li></ul></div></div><div class="widget-recent widget"><h4 class=widget__title>近期文章</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2025-04-19-cline%E4%B8%AD%E4%BD%BF%E7%94%A8-mysql-mcp-%E6%9C%8D%E5%8A%A1/>Cline中使用 MySql MCP 服务</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2020-09-03-%E5%9F%BA%E4%BA%8Elaravel%E5%8F%8Alayui%E5%BC%80%E5%8F%91%E7%9A%84%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F-laravel-wjfcms/>基于laravel及layui开发的后台管理系统 -- laravel-wjfcms</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2020-06-02-%E8%85%BE%E8%AE%AF%E4%BA%91%E4%BA%A7%E5%93%81%E5%A4%A7%E4%BF%83/>腾讯云产品大促</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2019-09-21-git%E6%93%8D%E4%BD%9C/>Git操作</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-29-openclaw-%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/>openclaw 安装及使用</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-28-mise-%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/>mise 安装及使用指南</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-26-%E7%94%A8-obsidian-%E6%89%93%E9%80%A0ai%E7%AC%94%E8%AE%B0/>用 Obsidian 打造AI笔记</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-22-claude-%E5%AE%98%E6%96%B9-skill-creator-%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/>Claude 官方 Skill-Creator 介绍及使用指南</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-22-%E9%80%9A%E8%BF%87qq%E9%82%AE%E7%AE%B1%E4%BB%A3%E6%94%B6gmail%E9%82%AE%E4%BB%B6/>通过QQ邮箱代收Gmail邮件</a></li><li class=widget__item><a class=widget__link href=/choudalao.github.io/posts/2026-01-19-%E8%A7%A3%E5%86%B3-wsl2-windows-hosts-%E5%BC%80%E5%90%AF-vpn-%E5%90%8E%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E6%9C%AC%E5%9C%B0-web-%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%97%AE%E9%A2%98/>解决 WSL2 + Windows Hosts + 开启 VPN 后无法访问本地 Web 服务的问题</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>标签</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/choudalao.github.io/tags/php/ title=Php>Php</a>
<a class="widget-taglist__link widget__link btn" href=/choudalao.github.io/tags/%E5%85%B3%E4%BA%8E/ title=关于>关于</a></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2026 臭大佬博客.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> 主题</span></div></div></footer></div><script async defer src=/choudalao.github.io/js/menu.js></script></body></html>