<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>docker 打包推送 + 钩子更新测试站容器 - 臭大佬博客</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="docker 打包推送 + 钩子更新测试站容器"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=臭大佬博客 rel=home><div class="logo__item logo__text"><div class=logo__title>臭大佬博客</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>首页</span></a></li><li class=menu__item><a class=menu__link href=/post/><span class=menu__text>归档</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>关于</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>docker 打包推送 + 钩子更新测试站容器</h1></header><div class="content post__content clearfix"><h1 id=问题>问题</h1><p>刚开始测试站更新的流程如下:</p><ul><li>本地构建<code>go</code>项目</li><li>本地打包镜像</li><li>本地推送镜像库</li><li>到测试服务器上,拉取镜像</li></ul><p>每次都要这么繁琐的操作,也是有点累,所以准备做一个升级,一步到位,思路如下
本地写一个脚本,主要是为了构建项目和推送镜像到远程仓库,然后测试站通过钩子触发更新镜像.</p><h1 id=方案>方案</h1><p>本地脚本 docker_build.sh</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>!<span style=color:#f92672>/</span><span style=color:#a6e22e>bin</span><span style=color:#f92672>/</span><span style=color:#a6e22e>bash</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>项目</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>obj</span>=<span style=color:#e6db74>&#34;admin&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>根据分支推送打包</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>branch</span>=<span style=color:#960050;background-color:#1e0010>$</span>(<span style=color:#a6e22e>git</span> <span style=color:#a6e22e>symbolic</span><span style=color:#f92672>-</span><span style=color:#a6e22e>ref</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>short</span> <span style=color:#a6e22e>HEAD</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> [ <span style=color:#e6db74>&#34;$branch&#34;</span> = <span style=color:#e6db74>&#34;develop&#34;</span> ]; <span style=color:#a6e22e>then</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>env</span>=<span style=color:#e6db74>&#34;test&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>elif</span> [ <span style=color:#e6db74>&#34;$branch&#34;</span> = <span style=color:#e6db74>&#34;master&#34;</span> ]; <span style=color:#a6e22e>then</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>env</span>=<span style=color:#e6db74>&#34;prod&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;请在 develop 上运行脚本, 当前分支:&#34;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>branch</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exit</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> [ ! <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span> ]; <span style=color:#a6e22e>then</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;运行条件不能为空&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exit</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> [[ <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;dev&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;prod&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;test&#34;</span> ]]; <span style=color:#a6e22e>then</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;运行条件错误&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exit</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;----- ${obj}: 重构镜像 -----&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;项目:&#34;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>obj</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;环境:&#34;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;git分支:&#34;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>branch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>提交时转换为LF</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>检出时转换为LF</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>git</span> <span style=color:#a6e22e>config</span> <span style=color:#a6e22e>core</span>.<span style=color:#a6e22e>autocrlf</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>git</span> <span style=color:#a6e22e>pull</span> <span style=color:#a6e22e>origin</span> <span style=color:#e6db74>&#34;$branch&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>遍历子模块</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;拉取子包&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>git</span> <span style=color:#a6e22e>submodule</span> <span style=color:#a6e22e>foreach</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>recursive</span> <span style=color:#e6db74>&#34;git checkout master -f &amp;&amp; git pull&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>git</span> <span style=color:#a6e22e>submodule</span> <span style=color:#a6e22e>update</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>remote</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span><span style=color:#f92672>-</span><span style=color:#a6e22e>compose</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>f</span> <span style=color:#a6e22e>docker</span><span style=color:#f92672>-</span><span style=color:#a6e22e>compose</span><span style=color:#f92672>-</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>yml</span> <span style=color:#a6e22e>build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;删除容器&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>containerID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;删除旧的tag包&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>image</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>com</span><span style=color:#f92672>/</span><span style=color:#a6e22e>containerID</span>:<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;打标签&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>tag</span> <span style=color:#a6e22e>containerID</span>:<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>com</span><span style=color:#f92672>/</span><span style=color:#a6e22e>containerID</span>:<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;推送到远程仓库&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>push</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>com</span><span style=color:#f92672>/</span><span style=color:#a6e22e>containerID</span>:<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>curl请求触发更新</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>whUrl</span>=<span style=color:#e6db74>&#34;http://xxx.com/webhook.php?branch=${branch}&amp;obj=${obj}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;请求地址:${whUrl}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>curl</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>X</span> <span style=color:#a6e22e>GET</span> <span style=color:#960050;background-color:#1e0010>$</span>{<span style=color:#a6e22e>whUrl</span>}
</span></span></code></pre></div><p>注释:
registry.example.com :仓库地址
branch:分支名,这里限制只能在develop和master分支触发打包
env: docker镜像的版本
obj: 项目
containerID: 容器ID</p><p>服务器上的webhook脚本 webhook.php</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span>&lt;<span style=color:#960050;background-color:#1e0010>?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 获取请求参数</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>obj</span> = <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>_GET</span>[<span style=color:#e6db74>&#34;obj&#34;</span>];
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>branch</span> = <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>_GET</span>[<span style=color:#e6db74>&#34;branch&#34;</span>];
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果有需要 可以打开下面，把传送过来的信息写进log 可用于调试，测试成功后注释即可</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果是develop分支</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strpos</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>branch</span>, <span style=color:#e6db74>&#34;develop&#34;</span>) <span style=color:#f92672>==</span>= <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>echo</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>branch</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// 更新的环境</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>objArr</span> = [<span style=color:#e6db74>&#34;bus&#34;</span>,<span style=color:#e6db74>&#34;admin&#34;</span>,<span style=color:#e6db74>&#34;user&#34;</span>,<span style=color:#e6db74>&#34;im&#34;</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ( !<span style=color:#a6e22e>in_array</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>obj</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>objArr</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>echo</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>obj</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 打开网站目录下的hooks.log文件 需要在服务器上创建 并给写权限</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span> = <span style=color:#a6e22e>fopen</span>(<span style=color:#960050;background-color:#1e0010>&#39;</span>.<span style=color:#f92672>/</span><span style=color:#a6e22e>webhooks_pull_</span><span style=color:#960050;background-color:#1e0010>&#39;</span> . <span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#34;m_d&#34;</span>) . <span style=color:#960050;background-color:#1e0010>&#39;</span>.<span style=color:#a6e22e>log</span><span style=color:#960050;background-color:#1e0010>&#39;</span>, <span style=color:#e6db74>&#39;a&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span>, <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>================</span> <span style=color:#a6e22e>Update</span> <span style=color:#a6e22e>Start</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>.<span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#34;H:i:s&#34;</span>) .<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>==============</span>=<span style=color:#960050;background-color:#1e0010>&#39;</span> . <span style=color:#a6e22e>PHP_EOL</span> . <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span>, <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>obj</span>: <span style=color:#960050;background-color:#1e0010>&#39;</span> . <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>obj</span> . <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span>, <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>branch</span>: <span style=color:#960050;background-color:#1e0010>&#39;</span> . <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>branch</span> . <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 执行shell命令,cd到网站根目录，执行git pull进行拉取代码，并把返回信息写进日志</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span>, <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>脚本</span>:<span style=color:#960050;background-color:#1e0010>&#39;</span> . <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>sh</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>www</span><span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>&#39;</span>.<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>obj</span>.<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span><span style=color:#a6e22e>run</span>.<span style=color:#a6e22e>sh</span>;<span style=color:#960050;background-color:#1e0010>&#39;</span> . <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>exec</span>(<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>sh</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>www</span><span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>&#39;</span>.<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>obj</span>.<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span><span style=color:#a6e22e>run</span>.<span style=color:#a6e22e>sh</span> <span style=color:#ae81ff>2</span>&gt;<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>&#39;</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>output</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>return_var</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span>, <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>Info</span>:<span style=color:#960050;background-color:#1e0010>&#39;</span> . <span style=color:#a6e22e>print_r</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>output</span>, <span style=color:#66d9ef>true</span>) . <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span>, <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>Return</span>:<span style=color:#960050;background-color:#1e0010>&#39;</span> . <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>return_var</span> . <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>fwrite</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span>, <span style=color:#a6e22e>PHP_EOL</span> . <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>================</span> <span style=color:#a6e22e>Update</span> <span style=color:#a6e22e>End</span> <span style=color:#f92672>==============</span>=<span style=color:#960050;background-color:#1e0010>&#39;</span> . <span style=color:#a6e22e>PHP_EOL</span> . <span style=color:#a6e22e>PHP_EOL</span>);
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>fclose</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>fs</span>);
</span></span></code></pre></div><p>测试站中的run.sh 脚本:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>!<span style=color:#f92672>/</span><span style=color:#a6e22e>bin</span><span style=color:#f92672>/</span><span style=color:#a6e22e>bash</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>show_usage</span>=<span style=color:#e6db74>&#34;args:[-e: dev,test,prod] [-j:Your Project Name] [-p: Port]&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>获取参数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>while</span> [ <span style=color:#f92672>-</span><span style=color:#a6e22e>n</span> <span style=color:#e6db74>&#34;$1&#34;</span> ]; <span style=color:#a6e22e>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;$1&#34;</span> <span style=color:#a6e22e>in</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>env</span>=<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shift</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    ;;
</span></span><span style=display:flex><span>  <span style=color:#f92672>--</span>) <span style=color:#66d9ef>break</span> ;;
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>echo</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>e</span> <span style=color:#e6db74>&#34;unsupported arg:$1,$2&#34;</span>,<span style=color:#e6db74>&#34;\n$show_usage&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    ;;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>esac</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>done</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>写死环境</span> <span style=color:#a6e22e>也可以根据上面的参数来</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>env</span>=<span style=color:#e6db74>&#34;test&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> [ ! <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span> ]; <span style=color:#a6e22e>then</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;运行条件不能为空&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exit</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> [[ <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;dev&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;prod&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;test&#34;</span> ]]; <span style=color:#a6e22e>then</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;运行条件错误&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exit</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>密码登陆</span> <span style=color:#a6e22e>username改成自己的账号</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;密码&#34;</span> | <span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>login</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>u</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>password</span><span style=color:#f92672>-</span><span style=color:#a6e22e>stdin</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;停止 containerID 容器运行&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>containerID</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span>  <span style=color:#e6db74>&#34;删除 containerID 容器&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>containerID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;删除镜像&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>image</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>com</span><span style=color:#f92672>/</span><span style=color:#a6e22e>containerID</span>:<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;拉取镜像&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>pull</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>com</span><span style=color:#f92672>/</span><span style=color:#a6e22e>containerID</span>:<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;新建容器&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>run</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>itd</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>p</span> <span style=color:#ae81ff>31000</span>:<span style=color:#ae81ff>31000</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>v</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>www</span><span style=color:#f92672>/</span><span style=color:#a6e22e>temp</span>:<span style=color:#f92672>/</span><span style=color:#a6e22e>containerID</span><span style=color:#f92672>/</span><span style=color:#a6e22e>temp</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>name</span> <span style=color:#a6e22e>containerID</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>com</span><span style=color:#f92672>/</span><span style=color:#a6e22e>containerID</span>:<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>----</span> <span style=color:#a6e22e>再做一个容器做负载</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>-----</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;停止 containerID-1 容器运行&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>containerID</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span>  <span style=color:#e6db74>&#34;删除 containerID-1 容器&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>containerID</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;新建容器-1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>run</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>itd</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>p</span> <span style=color:#ae81ff>31001</span>:<span style=color:#ae81ff>31000</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>v</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>www</span><span style=color:#f92672>/</span><span style=color:#a6e22e>temp1</span>:<span style=color:#f92672>/</span><span style=color:#a6e22e>containerID</span><span style=color:#f92672>/</span><span style=color:#a6e22e>temp</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>name</span> <span style=color:#a6e22e>containerID</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>com</span><span style=color:#f92672>/</span><span style=color:#a6e22e>containerID</span>:<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>env</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>----</span> <span style=color:#a6e22e>再做一个容器做负载</span> <span style=color:#a6e22e>end</span><span style=color:#f92672>-----</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;删除tag为none的镜像&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>images</span>|<span style=color:#a6e22e>grep</span> <span style=color:#a6e22e>none</span>|<span style=color:#a6e22e>awk</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>{<span style=color:#a6e22e>print</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span>}<span style=color:#960050;background-color:#1e0010>&#39;</span>|<span style=color:#a6e22e>xargs</span> <span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>rmi</span>
</span></span></code></pre></div><p>注意:上面只是一个例子,存在安全风险,请自行增加验证流程,做好防护措施.</p><h1 id=总结>总结</h1><p>本地运行<code>sh docker_build.sh</code>完成打包和推送镜像,还有触发了webhook的钩子,服务器就会去执行拉取镜像和更新的操作,至于gitwebhook的配置,可以自行百度.</p><h2 id=问题-1>问题</h2><p>这边使用php做的webhook,可能会没有权限操作 docker,
将 www 添加到 docker 用户组中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sudo</span> <span style=color:#a6e22e>usermod</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>aG</span> <span style=color:#a6e22e>docker</span> <span style=color:#a6e22e>www</span>
</span></span></code></pre></div><p>将文件的所属用户改为 root，所属群组改为 docker，并增加了群组读写权限rw。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sudo</span> <span style=color:#a6e22e>chown</span> <span style=color:#a6e22e>www</span>:<span style=color:#a6e22e>docker</span> <span style=color:#f92672>/</span><span style=color:#66d9ef>var</span><span style=color:#f92672>/</span><span style=color:#a6e22e>run</span><span style=color:#f92672>/</span><span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>sock</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sudo</span> <span style=color:#a6e22e>chmod</span> <span style=color:#a6e22e>g</span><span style=color:#f92672>+</span><span style=color:#a6e22e>rw</span> <span style=color:#f92672>/</span><span style=color:#66d9ef>var</span><span style=color:#f92672>/</span><span style=color:#a6e22e>run</span><span style=color:#f92672>/</span><span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>sock</span>
</span></span></code></pre></div><p>查询当前用户所属的用户组</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>groups</span> <span style=color:#a6e22e>www</span>
</span></span></code></pre></div><p>查询 docker 用户组中包含的所有用户</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>cat</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>etc</span><span style=color:#f92672>/</span><span style=color:#a6e22e>group</span> | <span style=color:#a6e22e>grep</span> <span style=color:#a6e22e>docker</span>
</span></span></code></pre></div></div></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2026 臭大佬博客.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> 主题</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>